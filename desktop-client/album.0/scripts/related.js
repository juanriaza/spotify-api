require(["$api/models","$views/image#Image","/strings/main.lang","/scripts/logger#Logger"],function(c,k,h,l){function a(b){this.album=b;this.albumId=b.uri.split(":")[2];this.artist=b.artists[0];this.artistId=this.artist.uri.split(":")[2];this.albumsPromise=new c.Promise;this.clickHandler=this.logClick.bind(this)}var i=h.get.bind(h),m=new l;a.prototype.init=function(){this._isVariousArtist()?this.albumsPromise.setFail():this.artist.load("albums").done(this,this._loadAlbumsSnapshot)};a.prototype.render=
function(b){this.albumsPromise.done(this,function(d){b.empty();for(var g=Math.min(8,d.length),a=0;a<g;a++)this._renderAlbum(b,d[a]);0<g&&this._renderMoreLink()})};a.prototype._loadAlbumsSnapshot=function(b){b.albums.snapshot(0,16).done(this,this._loadAlbumCandidates)};a.prototype._loadAlbumCandidates=function(b){this._getAlbums(b).done(this,this._resolveAlbums)};a.prototype._resolveAlbums=function(b){c.Promise.join(b).always(this,function(b){this.albumsPromise.setDone(b)})};a.prototype._getAlbums=
function(b){for(var d=new c.Promise,a=[],e=[],f=0,n=b.length;f<n;f++){var j=b.get(f);null!==j&&a.push(this._getPlayable(j))}c.Promise.join(a).each(this,function(b){e.push(b.load("name","image","artists"))}).always(this,function(){d.setDone(e)});return d};a.prototype._getPlayable=function(b){for(var d=new c.Promise,a=[],e=0,f=b.albums.length;e<f;e++)a.push(b.albums[e].load("playable"));c.Promise.join(a).always(this,function(b){for(var a=null,g=!1,c=0;c<f;c++)b[c].playable&&null==a&&(a=b[c]),b[c].uri===
this.album.uri&&(g=!0);null!==a&&!g?d.setDone(a):d.setFail()});return d};a.prototype._renderMoreLink=function(){var b=this.artist.uri.toSpotifyURL(),a=this.artist.name;-1<a.toLowerCase().indexOf("various")?(a=i("various-artists"),b='<span class="grey7">'+a+"</span>"):b='<a href="'+b+'" class="spuri">'+a+"</a>";document.getElement("#albums-more h2").innerHTML='<span class="grey7">'+i("more-by")+"</span> "+b};a.prototype._renderAlbum=function(b,a){var c=document.createElement("li");c.className="item cf mb";
this.image=k.forAlbum(a,{title:a.name,height:172,width:172,player:!1,animate:!1,link:a.uri,overlay:[a.name,this.artist.name]});this.image.node.setAttribute("data-related-type","image");this.image.node.addEventListener("click",this.clickHandler,!0);c.appendChild(this.image.node);b.appendChild(c)};a.prototype._isVariousArtist=function(){return 0<=this.artist.name.toLowerCase().indexOf("various")};a.prototype.destroy=function(){this.image&&this.image.node.removeEventListener("click",this.clickHandler,
!0);this.nameNode&&this.nameNode.removeEventListener("click",this.clickHandler,!0)};a.prototype.logClick=function(b){for(b=b.target;"A"!==b.nodeName.toUpperCase();)b=b.parentNode;var a=b.parentNode;"DIV"===a.nodeName.toUpperCase()&&(a=a.parentNode);var c=Array.prototype.indexOf.call(a.parentNode.childNodes,a)+1,a=b.getAttribute("data-related-type"),b={target:b.getAttribute("data-uri").split(":")[2],position:c};a&&(b.type=a);m.clientEvent("click-related-album",b)};exports.RelatedAlbums=a});
