require(["$api/models","/scripts/utils","/strings/main.lang"],function(k,p,m){function e(a){this.album=a;this.provider=new n(a)}function n(a){this.album=a}var h=k.Promise,i=h.join,l=m.get.bind(m);e.prototype.find=function(){var a={},b=new h(a),c=this.album.uri;this.provider.find().done(this,function(d){d=d.filter(function(a){return a.uri!=c});this._labelAlbums(d).done(this,function(c){a.albums=c;b.setDone()})});return b};e.prototype.createUniquesPlaylist=function(){var a=k.Playlist.createTemporary("extra-tracks-"+
this.album.uri),b={},c=new h(b);this.provider.find().done(this,function(d){var f=[],g={},d=d.concat(this.album);this._loadTracksFromAlbums(d).each(this,function(a){g[a.uri]=a.tracks;for(var c=0,b=a.tracks.length;c<b;c++){var d=a.tracks[c];!this._containsTrack(f,d)&&d.playable&&f.push(d)}}).always(this,function(){var d=this,e=f.filter(function(a){return!d._containsTrack(g[d.album.uri],a)});this._populatePlaylist(a,e).done(function(a){b.playlist=a.playlist;b.length=e.length;c.setDone()})})});return c};
e.prototype._populatePlaylist=function(a,b){var c={},d=new h(c);a.done(function(a){a.load("tracks").done(function(){a.tracks.clear().done(function(){a.tracks.add(b).done(function(){c.playlist=a;d.setDone()})})})});return d};e.prototype._labelAlbums=function(a){var b="name date discs availability type uri".split(" "),c="name date availability discs_length tracks_length type uri".split(" "),d=0,f=this,g=[],j=new h(g);c.forEach(function(){});i(a.map(function(a){return a.load(b.concat("playable"))})).done(function(a){void 0===
a||0==a.length?j.setDone():i(a.map(function(a){return a.playable?(d++,f._loadTransformed(a,c)):null}).filter(function(a){return null!==a})).done(function(a){for(var c=void 0!==a?a.length:0,d=0;d<c;d++){var b=a[d],f=b.name+", "+p.readableYear(b.date)+". "+b.tracks_length+" "+(1==b.tracks_length?l("track"):l("tracks"));"premium"==b.availability&&(f+=" ("+l("premium-edition")+")");g.push({uri:b.uri,name:f})}j.setDone()})});return j};e.prototype._make_discs_length=function(a,b){var c=a.load("discs");
c.done(function(a){b.discs_length=a.discs.length});return c};e.prototype._containsTrack=function(a,b){for(var c=0,d=a.length;c<d;c++)if(this._tracksEqual(a[c],b))return!0;return!1};e.prototype._tracksEqual=function(a,b){if(a.name.toLowerCase()===b.name.toLowerCase()&&2E3>=Math.abs(a.duration-b.duration)){for(var c=a.artists.length,d=0,f=c;d<f;d++)for(var g=0,j=b.artists.length;g<j;g++)a.artists[d]==b.artists[g]&&c--;if(0===c)return!0}return!1};e.prototype._loadTracksFromAlbums=function(a){var b=this._loadTracksFromAlbum.bind(this),
a=a.map(b);return i(a)};e.prototype._loadTracksFromAlbum=function(a){var b={uri:a.uri,tracks:[]},c=new h(b);this._allTracks(a).done(function(a){i(a).done(function(a){a=a.map(function(a){return a.loadAll("name","artists","duration","playable")});a.forEach(function(a){a.each(function(a){b.tracks.push(a)})});i(a).always(function(){c.setDone()})})});return c};e.prototype._allTracks=function(a){var b=[],c=new h(b);a.load("discs").done(function(a){i(a.discs.map(function(a){return a.load("tracks")})).always(function(a){a.forEach(function(a){b.push(a.tracks.snapshot())});
c.setDone()})});return c};e.prototype._make_tracks_length=function(a,b){var c=new h,d=0;this._allTracks(a).done(function(a){i(a).each(function(a){d+=a.range.length}).always(function(){b.tracks_length=d;c.setDone()})});return c};e.prototype._loadTransformed=function(a,b){var c={},d=new h(c),f=[],g=this;b.forEach(function(b){if(a.hasOwnProperty(b))c[b]=a[b];else if(g["_make_"+b])f.push(g["_make_"+b].call(g,a,c));else throw"Tried running _make_"+b+" but failed. This should not happen.";});0==f.length?
d.setDone():i(f).always(function(){d.setDone()});return d};n.prototype.find=function(){var a=[],b=new h(a);k.Artist.fromURI(this.album.artists[0].uri).load("albums").done(this,function(c){c.albums.snapshot().done(this,function(c){c.loadAll("albums").each(this,function(b){for(var c=!1,d=0,e=b.albums.length;d<e;d++)c=c||b.albums[d].uri===this.album.uri;c&&a.push.apply(a,b.albums)}).always(function(){b.setDone()})})});return b};exports.SimilarAlbums=e});
