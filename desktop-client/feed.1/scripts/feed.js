var sp=getSpotifyApi(),$language=sp.require("$util/language"),$dom=sp.require("$util/dom"),$models=sp.require("$api/models"),$popover=sp.require("$unstable/popover"),$presence=sp.require("$unstable/presence"),$react=sp.require("$util/react"),$staticdata=sp.require("$unstable/staticdata"),$storage=sp.require("$util/storage"),$views=sp.require("$api/views"),$i18n=sp.require("scripts/i18n"),$presenceFormatter=sp.require("/scripts/presence-formatter"),$miniPlayer=sp.require("/scripts/mini-player"),CATALOG=
$language.loadCatalog("feed",""),_=partial($language.getString,CATALOG,"presence"),_f=partial($language.getString,CATALOG,"feed"),$loggingHelper,CLEAN_INTERVAL=1E4,UPDATE_AFTER_ADD_TIMEOUT=100,MAX_ITEMS=30,SHARABLE_LINK_TYPES={1:1,2:1,4:1,5:1},LOGIN_TIMESTAMP=Date.now()/1E3;exports.Feed=Feed;
function Feed(){var d=this,b,i,g,f,h,j,k,p,q,r,s,m,t,u,v,l,n=0;b=new $presenceFormatter.PresenceFormatter(function(a,c,e,b){i(a,c,e,b)});b.stringFromArtistsArray=function(a){return'<span class="artist">'+map(function(a){return b.createLink(a.name.decodeForHTML(),a.uri)},a).join(", ")+"</span>"};b.createLink=function(a,c,e,b){void 0===e&&(e="");void 0===b&&(b="");return'<a href="'+c+'" class="'+e+'" data-uri="'+b+'">'+a+"</a>"};b.createDurationNode=function(a){return'<span class="duration">'+stringFromDuration(a)+
"</span>"};b.formatPlaylistPublished=function(a,c,e){return $language.format(_("playlistPublished"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6")))};b.formatPlaylistSubscribed=function(a,c,e,d){return $language.format(_("playlistSubscribed"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>'+_("itemByArtists")+"</div></div>",b.createLink(c.name.decodeForHTML(),
c.uri,"h6"),b.createLink(d.name.decodeForHTML(),d.uri)))};b.formatMyPlaylistSubscribed=function(a,c,e){return $language.format(_("myPlaylistSubscribed"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6")))};b.formatPlaylistTrackAdded=function(a,c,e){a=c[0];c=c[1];return $language.format(_("playlistTrackAdded"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),c?b.createLink(c.data.name.decodeForHTML(),
c.data.uri,"strong"):_("aPlaylist"),$language.format('<div class="info"><div>{0} {1} {2}</div></div>',b.createLink(a.name.decodeForHTML(),a.uri,"h6",a.album.uri),b.stringFromArtistsArray(a.artists),b.createDurationNode(a.duration)))};b.formatTrackStarred=function(a,c,e){return $language.format(_("playlistTrackStarred"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0} {1}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6",c.album.uri),b.stringFromArtistsArray(c.artists)))};
b.formatTrackFinishedPlaying=function(a,c,e){var d=null,d="#";a.type==$presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING&&a.appInfo&&""!==a.appInfo.name?(d="spotify:app:"+a.appInfo.application,d=$language.format('{0}<a class="app-link" href="'+d+'">{1}</a>',$language.format(_("trackFinishedPlaying"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0} {1}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6",c.album.uri),b.stringFromArtistsArray(c.artists))),
$language.format('<span class="app-icon" style="{1}"></span><span class=" app-info">{0}</span>',$language.format(_("usingApp"),a.appInfo.name),"background-image:url("+a.appInfo.icon_small+")"))):a.type==$presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING?(d=a.referrerUri,d=$language.format('{0}<a class="app-link" href="'+d+'">{1}</a>',$language.format(_("trackFinishedPlaying"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0} {1}</div></div>',b.createLink(c.name.decodeForHTML(),
c.uri,"h6",c.album.uri),b.stringFromArtistsArray(c.artists))),$language.format('<span class="app-icon radio" style="{1}"></span><span class=" app-info radio">{0}</span>',$language.format(_("usingApp"),"Spotify radio"),"background-image:url(sp://resources/img/buddylist-radio-icon.png)"))):d=$language.format(_("trackFinishedPlaying"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="info"><div>{0} {1}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6",c.album.uri),
b.stringFromArtistsArray(c.artists)));return d};b.formatTrackShared=function(a,c,e){a=a.message?"<em>"+a.message.decodeForHTML()+"</em>":"";return $language.format(_("userSharedTrack"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="bubble">{0} {1}</div>',a,$language.format('<div class="info"><div>{0} {1} {2}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6",c.album.uri),b.stringFromArtistsArray(c.artists),b.createDurationNode(c.duration))))};b.formatPlaylistShared=
function(a,c,e){a=a.message?"<em>"+a.message.decodeForHTML()+"</em>":"";return $language.format(_("userSharedPlaylist"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="bubble">{0}{1}</div>',a,$language.format('<div class="info"><div>{0}</div></div>',b.createLink(c.name.decodeForHTML(),c.uri,"h6"))))};b.formatAlbumShared=function(a,c,e){a=a.message?"<em>"+a.message.decodeForHTML()+"</em>":"";return $language.format(_("userSharedAlbum"),b.createLink(e.name.decodeForHTML(),
e.uri,"strong"),$language.format('<div class="bubble">{0}{1}</div>',a,$language.format('<div class="info"><div>'+_("itemByArtists")+"</div></div>",b.createLink(c.name.decodeForHTML(),c.uri,"h6"),b.stringFromArtistsArray([c.artist]))))};b.formatArtistShared=function(a,c,e){a=a.message?"<em>"+a.message.decodeForHTML()+"</em>":"";return $language.format(_("userSharedArtist"),b.createLink(e.name.decodeForHTML(),e.uri,"strong"),$language.format('<div class="bubble">{0}{1}</div>',a,$language.format('<div class="info"><div>{0}</div></div>',
b.createLink(c.name.decodeForHTML(),c.uri,"h6"))))};b.formatFavouriteAppAdded=function(a,c){var e=null;return e=$language.format('<span class="info">{0}</span><a class="app-link" href="spotify:app:'+a.appInfo.application+'">{1}</a>',$language.format(_("userAddedApp"),$language.format("<strong>{0}</strong>",c.name.decodeForHTML()),a.appInfo.name),$language.format('<span class="app-icon-big" style="{1}"></span><span class=" app-info">{0}</span>',a.appInfo.name,"background-image:url('"+a.appInfo.icon_medium+
"')"))};r=function(a){if(!a.loadedArtwork){a.loadedArtwork=!0;var c=a.state,e=null,b;if(c.type===$presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING||c.type===$presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING||c.type===$presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING||c.type===$presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED||c.type===$presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED||c.type===$presence.PresenceState.TYPE.TRACK_SHARED)b=$dom.queryOne(".info",a.node),s(c,b);else if(c.type===
$presence.PresenceState.TYPE.ALBUM_SHARED)$models.Album.fromURI(c.albumUri,function(b){if(b.data){var d=$dom.queryOne(".info",a.node);e=new $views.Image(b.data.cover,c.albumUri,$language.format(_("itemByArtists"),b.data.name.decodeForHTML(),b.data.artist.name.decodeForHTML()));e.node.classList.add("cover");d.appendChild(e.node)}});else if(c.type===$presence.PresenceState.TYPE.ARTIST_SHARED)b=$dom.queryOne(".info",a.node),e=document.createElement("a"),e.href=c.artistUri,e.className="sp-image artist",
b.appendChild(e);else if(c.type===$presence.PresenceState.TYPE.PLAYLIST_PUBLISHED||c.type===$presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED||c.type===$presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED||c.type===$presence.PresenceState.TYPE.PLAYLIST_SHARED){-1<c.playlistUri.indexOf(":publishedstarred")&&(c.playlistUri=c.playlistUri.replace("publishedstarred","starred"));var d=sp.core.getPlaylist(c.playlistUri,!1),h=function(){if(0<d.cover.length||!e){0<d.cover.length&&d.removeEventListener("change",
h);e&&(e.node&&e.node.parentNode&&e.node.parentNode.removeChild(e.node),e=null);e=new $views.Image(d.cover,c.playlistUri);var b=$dom.queryOne(".info",a.node),x=$dom.queryOne(".info > div",a.node);if(0<d.subscriberCount){var f=new $dom.Element("span",{innerHTML:$i18n.number(d.subscriberCount)+" "+(1===d.subscriberCount?_("follower"):_("followers"))});x.appendChild(f)}e.node.classList.add("playlist");b.appendChild(e.node)}};d.loaded?h():d.addEventListener("change",h)}}};s=function(a,c){var e=function(){var b=
new $miniPlayer.MiniPlayer;b.loadURI(a.trackUri);c.appendChild(b.node);this.removeEventListener("mouseover",e)};if(a.type===$presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING||a.type===$presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING||a.type===$presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING||a.type===$presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED||a.type===$presence.PresenceState.TYPE.TRACK_SHARED)$models.Track.fromURI(a.trackUri,function(a){function b(a){a=new $views.Image(a);
a.node.addEventListener("mouseover",e);a.node.classList.add("track");c.appendChild(a.node)}!a||!a.data||!a.data.album?b(""):a.data.album.cover?b(a.data.album.cover):a.data.album.uri&&$models.Album.fromURI(a.data.album.uri,function(a){b(a.data.cover)})});else if(a.type===$presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED){var b=new $dom.Element("div",{className:"placeholder"});b.classList.add("starred");b.addEventListener("mouseover",e);c.appendChild(b)}};m=function(a){var c=b.stickyFactor(a.type);
return a.timestamp+20*c};l=function(){for(var a=0,c=d.node.childNodes,b=0,h=c.length;b<h;b++)a+=c[b].offsetHeight;d.node.style.height=a+"px"};v=function(a,c){var b=c.node,d=b.offsetHeight;(c.state.type===$presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED||c.state.type===$presence.PresenceState.TYPE.PLAYLIST_PUBLISHED||c.state.type===$presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED||c.state.type===$presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED||c.state.type===$presence.PresenceState.TYPE.TRACK_SHARED||
c.state.type===$presence.PresenceState.TYPE.PLAYLIST_SHARED||c.state.type===$presence.PresenceState.TYPE.ALBUM_SHARED)&&b.classList.add("big-image");a?(b.addEventListener("webkitAnimationEnd",function y(){l();b.removeEventListener("webkitAnimationEnd",y)}),b.style.marginTop=-d+"px",b.classList.add("show"),b.style.marginTop="0"):l()};t=function(a,c){d.items.splice(c,0,a);d.node.insertBefore(a.node,d.node.childNodes[c]);return a};k=function(a,c){return a.username===c.username&&a.timestamp===c.timestamp};
f=function(a){for(var c=!1,b=0,h=d.items.length;b<h;++b)if(k(a,d.items[b].state)){c=!0;break}return c};g=function(a,c){return compare(m(a.state),m(c.state))};p=function(a){if(a.state.atFront)return 0;for(var c=d.items,b=0,h=c.length;b<h&&1!==g(a,c[b]);++b);return b};q=function(a){return f(a.state)?a:t(a,p(a))};i=function(a,c,b,d){var f=!1;if(!$popover.popover||!$popover.popover.visible)d||(f=!0),v(f,q(new FeedItem(a,c,b))),n&&clearTimeout(n),n=setTimeout(h,UPDATE_AFTER_ADD_TIMEOUT)};u=function(a){a=
d.items.splice(a,1)[0];d.node.removeChild(a.node)};h=function(){j();for(var a=d.node.parentNode,c=a.scrollTop,a=c+a.offsetHeight,b=0,h=0,f=d.items.length;h<f;h++){var g=d.items[h],k=h+1<f?d.items[h+1].node.offsetHeight:0,b=b+g.node.offsetHeight;b>=c&&b<=a+k&&r(g)}};j=function(){for(var a=0,c=n=0,b=d.items.length;c<b;c++)a+=d.items[c].node.offsetHeight;for(;d.items.length>MAX_ITEMS&&a>d.node.parentNode.offsetHeight;)a-=d.items[d.items.length-1].node.offsetHeight,u(d.items.length-1);l()};d.node=document.createElement("div");
d.node.className="feed";d.items=[];d.addItemForState=b.formatState;d.addItemsForStates=b.formatStates;d.getStickyness=m;d.setLoggingHelper=function(a){$loggingHelper=a;$loggingHelper.getTestGroup();$miniPlayer.setLoggingHelper(a)};d.showLoader=function(){if(!document.querySelector("#feed .loader")){var a=document.createElement("div");a.innerHTML=_f("updating");a.className="loader";d.node.parentNode.insertBefore(a,d.node);l()}};d.hideLoader=function(){var a=document.querySelector("#feed .loader");
a&&a.parentNode.removeChild(a);l()};d.noFeedItemsMessage=function(){if(!document.querySelector(".no-items")){var a=document.createElement("div");a.className="no-items";var b="<h1>"+_f("introductionTitle")+"</h1>",b=b+'<a class="button peopleButton" href="spotify:app:people">'+_f("showPeople"),b=b+"</a>";a.innerHTML=b;$dom.adopt(d.node,a)}};d.hideNoFeedItemsMessage=function(){var a=document.querySelector(".no-items");a&&a.parentNode.removeChild(a)};d.isEmpty=function(){return 0===$dom.query(".item",
d.node).length?!0:!1};setInterval(j,CLEAN_INTERVAL);var w=new $react.EventStream,z=$react.throttle(w,500);d.node.addEventListener("DOMNodeInsertedIntoDocument",function c(){d.node.removeEventListener("DOMNodeInsertedIntoDocument",c);d.node.parentNode.addEventListener("scroll",function(){$react.publish(w,null)})});z.subscribe(h);return d}
function FeedItem(d,b,i){var g=this;g.state=d;g.node=document.createElement("div");g.loadedArtwork=!1;var f=g.node;f.appendChild(i);f.className="item type-"+d.type;f.title=b.name.decodeForText();$react.fromDOMEvent(f,"dragover").subscribe(function(b){var d=sp.core.getLinkType(b.dataTransfer.getData("text"));SHARABLE_LINK_TYPES[d]&&b.preventDefault()});$react.fromDOMEvent(f,"dragenter").subscribe(function(b){var d=sp.core.getLinkType(b.dataTransfer.getData("text"));SHARABLE_LINK_TYPES[d]?b.target.classList.add("drag-over"):
b.dataTransfer.dropEffect="none"});$react.merge($react.fromDOMEvent(f,"drop"),$react.fromDOMEvent(f,"dragleave")).subscribe(function(b){b.target.classList.remove("drag-over")});$react.fromDOMEvent(f,"drop").subscribe(function(d){d.preventDefault();d.stopPropagation();var j=d.dataTransfer.getData("text"),k=sp.core.getLinkType(j);SHARABLE_LINK_TYPES[k]?($popover.popover&&$popover.popover.targetNode===d.target&&$popover.popover.hide(!0),$popover.sharePopup(b,j,f,{relativeNode:g.node.parentNode.parentNode})):
sp.core.showClientMessage(0,$language.format($language.getString(CATALOG,"friendslist","unsupportedDropType"),sp.core.user.name.decodeForText()))});$react.fromDOMEvent(g.node,"click").subscribe(function(b){if("A"===b.target.tagName){var d="link";b.target.className.match(/play/)&&(d="player");b.target.className.match(/sp-image/)&&(d="image");var f=extractStateForLogging(g.state);f.uri=b.target.href;f.type=g.state.type;$loggingHelper.logClientEvent("feed link clicked",d,f);4===sp.core.getLinkType(b.target.href)&&
(b.preventDefault(),b.stopPropagation(),window.open(b.target.getAttribute("data-uri")))}});return g}function extractStateForLogging(d){for(var b="albumUri artistUri playlistUri trackUri appUri contextUri referrerUri".split(" "),i={},g=0;g<b.length;g++){var f=b[g];d.hasOwnProperty(f)&&null!==d[f]&&(i[f]=d[f])}return i}function stringFromDuration(d){var b=~~(d/1E3+0.5),d=~~(b/60),b=b-60*d;return d+":"+(9<b?b:"0"+b)};
