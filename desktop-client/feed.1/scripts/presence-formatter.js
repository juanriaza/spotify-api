var sp=getSpotifyApi(),$metadata=sp.require("$api/metadata"),$models=sp.require("$api/models"),$presence=sp.require("$unstable/presence"),METADATA_BATCH_SIZE=25;exports.PresenceFormatter=PresenceFormatter;
function PresenceFormatter(p){function h(a,c,d,b){var k=l.cloneNode();k.innerHTML=d;p(a,c,k,b)}function t(a,c,d){g([a.username],function(b){h(a,b[0],f.formatPlaylistPublished(a,c,b[0]),d)})}function u(a,c,d){a.type==$presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED?g([a.username],function(b){h(a,b[0],f.formatMyPlaylistSubscribed(a,c,b[0]),d)}):g([a.username,c.owner.canonicalUsername],function(b){h(a,b[0],f.formatPlaylistSubscribed(a,c,b[0],b[1]),d)})}function v(a,c,d){a.type==$presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED?
c.isInvalid||g([a.username],function(b){h(a,b[0],f.formatTrackStarred(a,c,b[0]),d)}):$models.Playlist.fromURI(a.playlistUri,function(b){g([a.username],function(k){h(a,k[0],f.formatPlaylistTrackAdded(a,[c,b],k[0]),d)})})}function w(a,c,d){if(!(c.isInvalid||""===c.name)){var b=function(){g([a.username],function(b){h(a,b[0],f.formatTrackFinishedPlaying(a,c,b[0]),d)})};a.type==$presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING||a.type==$presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING?sp.installer.getApplicationInfo(a.referrerUri,
{onSuccess:function(c){a.appInfo=c;b(c)},onFailure:function(){b()}}):b()}}function x(a,c,d){g([a.username],function(b){h(a,b[0],f.formatTrackShared(a,c,b[0]),d)})}function y(a,c,d){g([a.username,c.owner.canonicalUsername],function(b){h(a,b[0],f.formatPlaylistShared(a,c,b[0],b[1]),d)})}function z(a,c,d){g([a.username],function(b){h(a,b[0],f.formatAlbumShared(a,c,b[0]),d)})}function A(a,c,d){g([a.username],function(b){h(a,b[0],f.formatArtistShared(a,c,b[0]),d)})}function B(a,c,d){g([a.username],function(b){sp.installer.getApplicationInfo(a.appUri,
{onSuccess:function(c){a.appInfo=c;h(a,b[0],f.formatFavouriteAppAdded(a,b[0]),d)},onFailure:function(){}})})}function g(a,c){sp.social.getUsersBatch(a,{onSuccess:function(a){c(a)},onFailure:function(){console.log("error loading users",a)}})}function m(a,c){for(var d=[],b=[],f={uri:null,callback:null},h=1<a.length,g=0,l=a.length;g<l;g++){var n=a[g],i=n,e=f;switch(i.type){case $presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING:e.uri=
i.trackUri;e.callback=w;break;case $presence.PresenceState.TYPE.PLAYLIST_PUBLISHED:e.uri=i.playlistUri;e.callback=t;break;case $presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED:e.uri=i.playlistUri;e.callback=u;break;case $presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED:case $presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED:e.uri=i.trackUri;e.callback=v;break;case $presence.PresenceState.TYPE.APP_ADDED:e.uri=null;e.callback=B;break;case $presence.PresenceState.TYPE.TRACK_SHARED:e.uri=
i.trackUri;e.message=i.message;e.callback=x;break;case $presence.PresenceState.TYPE.PLAYLIST_SHARED:e.uri=i.playlistUri;e.message=i.message;e.callback=y;break;case $presence.PresenceState.TYPE.ALBUM_SHARED:e.uri=i.albumUri;e.message=i.message;e.callback=z;break;case $presence.PresenceState.TYPE.ARTIST_SHARED:e.uri=i.artistUri;e.message=i.message;e.callback=A;break;default:e.uri=null,e.callback=null}if(f.uri)d.push(f.uri),b.push(partial(f.callback,n));else if(f.callback)try{f.callback(n,null,h)}catch(m){console.log("error formatting state",
n,m)}}0===d.length&&c();var q=null,r=null,j=0,p=function(a,b){"function"===typeof c&&(c(),c=null);if(b){b instanceof Array||(b=[b]);for(var d=0,e=b.length;d<e;d++)if(b[d])try{a[d](b[d],h)}catch(f){console.log("error formatting state",b[d],f)}}s()},s=function(){j<d.length&&(q=d.slice(j,j+METADATA_BATCH_SIZE),r=b.slice(j,j+METADATA_BATCH_SIZE),j+=METADATA_BATCH_SIZE,$metadata.getMetadata(q,partial(p,r)))};s()}var f=this,l=document.createElement("div");l.className="sp-presence";f.formatState=function(a){m([a])};
f.formatStates=m;f.stickyFactor=function(a){switch(a){case $presence.PresenceState.TYPE.UNKNOWN:case $presence.PresenceState.TYPE.FACEBOOK_ACTIVITY:case $presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.TRACK_STARTED_PLAYING:return 0;case $presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED:return 1;case $presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING:return 2;case $presence.PresenceState.TYPE.PLAYLIST_PUBLISHED:case $presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED:case $presence.PresenceState.TYPE.APP_ADDED:case $presence.PresenceState.TYPE.TRACK_SHARED:case $presence.PresenceState.TYPE.PLAYLIST_SHARED:case $presence.PresenceState.TYPE.ALBUM_SHARED:case $presence.PresenceState.TYPE.ARTIST_SHARED:return 3;
default:return 0}};return f};
