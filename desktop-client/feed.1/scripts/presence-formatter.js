var sp=getSpotifyApi(),$metadata=sp.require("$api/metadata"),$models=sp.require("$api/models"),$presence=sp.require("$unstable/presence"),TYPE=$presence.PresenceState.TYPE,METADATA_BATCH_SIZE=25;exports.PresenceFormatter=PresenceFormatter;
function PresenceFormatter(p){function i(a,c,d,b){var l=m.cloneNode();l.innerHTML=d;p(a,c,l,b)}function t(a,c,d){h([a.username],function(b){i(a,b[0],f.formatPlaylistPublished(a,c,b[0]),d)})}function u(a,c,d){a.type==$presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED?h([a.username],function(b){i(a,b[0],f.formatMyPlaylistSubscribed(a,c,b[0]),d)}):h([a.username,c.owner.canonicalUsername],function(b){i(a,b[0],f.formatPlaylistSubscribed(a,c,b[0],b[1]),d)})}function v(a,c,d){a.type==$presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED?
c.isInvalid||h([a.username],function(b){i(a,b[0],f.formatTrackStarred(a,c,b[0]),d)}):$models.Playlist.fromURI(a.playlistUri,function(b){h([a.username],function(l){i(a,l[0],f.formatPlaylistTrackAdded(a,[c,b],l[0]),d)})})}function w(a,c,d){if(!(c.isInvalid||""===c.name)){var b=function(){h([a.username],function(b){i(a,b[0],f.formatTrackFinishedPlaying(a,c,b[0]),d)})};a.type==$presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING||a.type==$presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING?sp.installer.getApplicationInfo(a.referrerUri,
{onSuccess:function(c){a.appInfo=c;b(c)},onFailure:function(){b()}}):b()}}function x(a,c,d){h([a.username],function(b){i(a,b[0],f.formatTrackShared(a,c,b[0]),d)})}function y(a,c,d){h([a.username,c.owner.canonicalUsername],function(b){i(a,b[0],f.formatPlaylistShared(a,c,b[0],b[1]),d)})}function z(a,c,d){h([a.username],function(b){i(a,b[0],f.formatAlbumShared(a,c,b[0]),d)})}function A(a,c,d){h([a.username],function(b){i(a,b[0],f.formatArtistShared(a,c,b[0]),d)})}function B(a,c,d){h([a.username],function(b){sp.installer.getApplicationInfo(a.appUri,
{onSuccess:function(c){a.appInfo=c;i(a,b[0],f.formatFavouriteAppAdded(a,b[0]),d)},onFailure:function(){}})})}function h(a,c){sp.social.getUsersBatch(a,{onSuccess:function(a){c(a)},onFailure:function(){console.log("error loading users",a)}})}function n(a,c){for(var d=[],b=[],f={uri:null,callback:null},i=1<a.length,h=0,m=a.length;h<m;h++){var j=a[h],g=!1;if(j.username!==sp.core.user.canonicalUsername||j.type===TYPE.TRACK_SHARED||j.type===TYPE.PLAYLIST_SHARED||j.type===TYPE.ALBUM_SHARED||j.type===TYPE.ARTIST_SHARED)g=
!0;if(g){var g=j,e=f;switch(g.type){case $presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING:e.uri=g.trackUri;e.callback=w;break;case $presence.PresenceState.TYPE.PLAYLIST_PUBLISHED:e.uri=g.playlistUri;e.callback=t;break;case $presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED:e.uri=g.playlistUri;e.callback=u;break;case $presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED:case $presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED:e.uri=
g.trackUri;e.callback=v;break;case $presence.PresenceState.TYPE.APP_ADDED:e.uri=null;e.callback=B;break;case $presence.PresenceState.TYPE.TRACK_SHARED:e.uri=g.trackUri;e.message=g.message;e.callback=x;break;case $presence.PresenceState.TYPE.PLAYLIST_SHARED:e.uri=g.playlistUri;e.message=g.message;e.callback=y;break;case $presence.PresenceState.TYPE.ALBUM_SHARED:e.uri=g.albumUri;e.message=g.message;e.callback=z;break;case $presence.PresenceState.TYPE.ARTIST_SHARED:e.uri=g.artistUri;e.message=g.message;
e.callback=A;break;default:e.uri=null,e.callback=null}if(f.uri)d.push(f.uri),b.push(partial(f.callback,j));else if(f.callback)try{f.callback(j,null,i)}catch(n){console.log("error formatting state",j,n)}}}0===d.length&&c();var q=null,r=null,k=0,p=function(a,b){"function"===typeof c&&(c(),c=null);if(b){b instanceof Array||(b=[b]);for(var d=0,e=b.length;d<e;d++)if(b[d])try{a[d](b[d],i)}catch(f){console.log("error formatting state",b[d],f)}}s()},s=function(){k<d.length&&(q=d.slice(k,k+METADATA_BATCH_SIZE),
r=b.slice(k,k+METADATA_BATCH_SIZE),k+=METADATA_BATCH_SIZE,$metadata.getMetadata(q,partial(p,r)))};s()}var f=this,m=document.createElement("div");m.className="sp-presence";f.formatState=function(a){n([a])};f.formatStates=n;f.stickyFactor=function(a){switch(a){case $presence.PresenceState.TYPE.UNKNOWN:case $presence.PresenceState.TYPE.FACEBOOK_ACTIVITY:case $presence.PresenceState.TYPE.TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.TRACK_STARTED_PLAYING:return 0;case $presence.PresenceState.TYPE.PLAYLIST_TRACK_ADDED:return 1;
case $presence.PresenceState.TYPE.RADIO_TRACK_FINISHED_PLAYING:case $presence.PresenceState.TYPE.APP_TRACK_FINISHED_PLAYING:return 2;case $presence.PresenceState.TYPE.PLAYLIST_PUBLISHED:case $presence.PresenceState.TYPE.PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.MY_PLAYLIST_SUBSCRIBED:case $presence.PresenceState.TYPE.PLAYLIST_TRACK_STARRED:case $presence.PresenceState.TYPE.APP_ADDED:case $presence.PresenceState.TYPE.TRACK_SHARED:case $presence.PresenceState.TYPE.PLAYLIST_SHARED:case $presence.PresenceState.TYPE.ALBUM_SHARED:case $presence.PresenceState.TYPE.ARTIST_SHARED:return 3;
default:return 0}};return f};
