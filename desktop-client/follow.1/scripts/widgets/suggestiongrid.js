require(["$api/models","$shared/events#EventHandler","$views/utils/css","scripts/widgets/suggestion#Suggestion"],function(e,f,h,g){function d(a,b){e.Observable.call(this);this.displayCount=b;this.suggestions=[];this.source=a;this._eventHandler=new f(this)}SP.inherit(d,e.Observable);d.prototype._addSuggestions=function(a){for(var b=0;b<a.length;b++){var c=new g(a[b]);this.addSuggestion(c)}this.dispatchEvent({type:"displaycountchange",displayCount:this.suggestions.length});this.dispatchEvent({type:"sourcechange"})};
d.prototype._translateEvent=function(a,b){var c=this.getNode().querySelectorAll(".suggestion"),c={index:Array.prototype.indexOf.call(c,a.getNode())};switch(b.type){case "navigate":c.type="navigate";c.href=b.href;break;case "dismiss":c.type="dismiss";c.user=b.user;break;case "subscriptionchange":if(!b.user.subscribed)return;c.type="subscribe";c.user=b.user;break;default:return}this.dispatchEvent(c)};d.prototype.addSuggestion=function(a){function b(a){c._translateEvent(this,a)}var c=this;a.addEventListener("profileclick",
b);a.addEventListener("dismiss",b);a.addEventListener("subscriptionchange",b);this._eventHandler.listen(a,"removing",function(b){b.preventDefault();this.source.get(1).done(this,function(b){a.set(b[0]);this.dispatchEvent({type:"sourcechange"})}).fail(this,function(){this.removeSuggestion(a)})});this.getNode().appendChild(a.getNode());this.suggestions.push(a)};d.prototype.dispose=function(){if(this._node){this._eventHandler.removeAll();this._node.parentNode&&this._node.parentNode.removeChild(this._node);
for(var a=0,b=this.suggestions.length;a<b;a++)this.suggestions[a].dispose();delete this.suggestions;delete this.suggestionSource;delete this._eventHandler;delete this._node}};d.prototype.getNode=function(){if(this._node)return this._node;var a=document.createElement("div");a.className="suggestion-grid container";this._node=a;this.source.get(this.displayCount).always(this,this._addSuggestions);return a};d.prototype.moreAvailable=function(){return this.suggestions.length>=this.displayCount};d.prototype.refresh=
function(){for(var a=300/this.suggestions.length,b=0;b<this.suggestions.length;b++){var c=this.suggestions[b];this.source.restore(c.data);setTimeout(function(a){return function(){a.remove()}}(c),b*a)}this.dispatchEvent({type:"sourcechange"})};d.prototype.removeSuggestion=function(a){var b=this.suggestions.indexOf(a);-1!=b&&(this.suggestions.splice(b,1),a.dispose(),this.dispatchEvent({type:"displaycountchange",displayCount:this.suggestions.length}))};exports.SuggestionGrid=d});
