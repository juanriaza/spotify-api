require("scripts/profile-utils scripts/controller#Controller $api/activity#Feed $api/models $views/image#Image $views/utils/css strings/activity.lang strings/playlist.lang".split(" "),function(g,r,s,l,j,k,d,p){var h=SP.bind(d.get,d),q=SP.bind(p.get,p),m,n,d=function(){this.init()};SP.inherit(d,r);d.prototype.initialize=function(a,b,c,e){this.isSelf=a;m=this.user=b;n=e;this.feed=null;this.activities=[];this.lastRenderedActivity=this.activitiesSnapshot=null;this.templates=c;this.container=document.querySelector(".app-activity");
this.itemsNode=null;this.numberOfRenderedItems=0;this.reloadTimeout=null;this.reloadFlag=!0;this.reloadCounter=0;this.loadActivities()};d.prototype.reload=function(){clearTimeout(this.reloadTimeout);this.reloadFlag&&2>this.reloadCounter&&(this.destroy(),this.loadActivities(),this.reloadCounter++)};d.prototype.loadActivities=function(){this.numberOfRenderedItems=0;this.feed||(this.feed=s.forUser(this.user));this.feed.load("activities").done(this.loadSnaphot.bind(this)).fail(function(a,b){console.error("(ActivityController) loading activities failed",
a,b)})};d.prototype.loadSnaphot=function(){this.feed.activities.snapshot().done(this.resolveSnapshot.bind(this)).fail(function(a,b){console.error("(ActivityController) activities snapshot failed",a,b)})};d.prototype.resolveSnapshot=function(a){if(0===a.length)this.container.style.display="none";else{this.container.style.display="";var b=[];this.activitiesSnapshot=a;for(var c=a.range.length-1,e=0;0<=c&&5>e;c--){var d=a.get(c),f=i.getType(d);if("UNKNOWN"!==f&&!("TRACK_FINISHED_PLAYING"===f||"APP_TRACK_FINISHED_PLAYING"===
f||"RADIO_TRACK_FINISHED_PLAYING"===f))b.push(d.load("activityType","item","timestamp")),e++}this.lastRenderedActivity=c;l.Promise.join(b).always(this.activitiesLoaded.bind(this))}};d.prototype.activitiesLoaded=function(a){a&&(this.activities=a);this.render()};d.prototype.render=function(){if(this.activities&&0<this.activities.length){this.renderHeader();this.renderLoader();this.itemsNode=this.container.querySelector(".recent-activity");for(var a=0,b=this.activities.length;a<b;a++)this.loadActivityData(this.activities[a],
a);this.reloadTimeout=setTimeout(this.reload.bind(this),2E3)}};d.prototype.renderLoader=function(){var a=this.container.querySelector(".recent-activity"),b=document.createElement("div");k.addClass(b,"loader");b.innerHTML=h("loadingActivities");a.appendChild(b)};d.prototype.removeLoader=function(){var a=this.container.querySelector(".loader");a&&a.parentNode.removeChild(a)};d.prototype.renderHeader=function(){this.container.innerHTML=this.templates.activity({activity:{heading:h("recentActivity")}})};
d.prototype.loadActivityData=function(a){var b=[];if("PLAYLIST_TRACK_STARRED"===i.getType(a)){var c=a.item.uri.split(":");c[3]="starred";a.item.uri=c.join(":")}b.push(a.item.load("name","image"));("PLAYLIST_TRACK_STARRED"===i.getType(a)||"PLAYLIST_TRACK_ADDED"===i.getType(a)||"TRACK_SHARED"===i.getType(a))&&a.context&&b.push(a.context.load("name"));"PLAYLIST_TRACK_STARRED"===i.getType(a)||"TRACK_SHARED"===i.getType(a)||"ALBUM_SHARED"===i.getType(a)?l.Promise.join(b).done(this.loadMoreData.bind(this,
a)).fail(this.loadNextActivity.bind(this)):l.Promise.join(b).done(this.renderItem.bind(this,a)).fail(this.loadNextActivity.bind(this))};d.prototype.loadMoreData=function(a){var b=a.item;"PLAYLIST_TRACK_STARRED"===i.getType(a)&&(b=a.context);b&&b.artists&&b.artists[0]?b.artists[0].load("name").done(this.renderItem.bind(this,a)).fail(this.loadNextActivity.bind(this)):this.loadNextActivity(a)};d.prototype.loadNextActivity=function(){console.error("(Activity) promise loading activities failed",arguments);
0<this.lastRenderedActivity&&(this.activitiesSnapshot.get(this.lastRenderedActivity).load("activityType","item","timestamp").done(this.loadActivityData.bind(this)),this.lastRenderedActivity--)};d.prototype.renderItem=function(a){if(5<=this.numberOfRenderedItems)return!1;this.removeLoader();this.reloadFlag=!1;i.getType(a);var b=document.createElement("div");k.addClass(b,"item");a.message&&k.addClass(b,"with-message");b.dataset.timestamp=Number(a.timestamp);b.innerHTML=this.templates.activity_item({activity:{duration:0!==
Number(a.timestamp)?g.timeAgo(a.timestamp):"",message:a.message?a.message:"",text:this.activityText(a)}});var c=b.querySelector(".item-image");this.insertActivityNode(b);var e=j.forUser(this.user,{animate:!0,height:40,width:40});this.numberOfRenderedItems++;c.appendChild(e.node);this.renderExtendedInfo(a,b)};d.prototype.insertActivityNode=function(a){for(var b=this.itemsNode.querySelectorAll(".item"),c=0,e=b.length,d=0;c<e;c++)b[c].dataset.timestamp>a.dataset.timestamp&&d++;this.itemsNode.insertBefore(a,
b[d])};d.prototype.activityText=function(a){var b=i.getType(a),c,e="<strong>"+g.userFirstName(this.user)+"</strong>",d="";a.item&&(d=g.createLinkHelper(a.item.uri,a.item.name));var f="";a.context&&a.context.name&&(f=g.createLinkHelper(a.context.uri,a.context.name));switch(b){case "PLAYLIST_PUBLISHED":c=h("publishedThePlaylist",e);break;case "PLAYLIST_SUBSCRIBED":c=h("nowFollowsThePlaylist",e);break;case "MY_PLAYLIST_SUBSCRIBED":c=h("nowFollowsYourPlaylist",e);break;case "PLAYLIST_TRACK_STARRED":a=
g.createLinkHelper(a.context.artists[0].uri,a.context.artists[0].name);c=h("starredATrackBy",e,f,a);break;case "PLAYLIST_TRACK_ADDED":c=h("addedTrackToPlaylist",e,f,d);break;case "APP_ADDED":c=h("addedTheApp",e,+d);break;case "TRACK_SHARED":c=h("sharedATrackBy",e);break;case "PLAYLIST_SHARED":c=h("sharedAPlaylist",e);break;case "ALBUM_SHARED":c=h("sharedAnAlbumBy",e);break;case "ARTIST_SHARED":c=h("sharedAnArtist",e);break;case "ARTIST_FOLLOWED":c=h("follows",e,d);break;case "TRACK_STARTED_PLAYING":case "UNKNOWN":break;
default:c=b}return c};d.prototype.renderExtendedInfo=function(a,b){var c=i.getType(a),e,d,f=document.createElement("div");k.addClass(f,"additional-info");e={animate:!0,height:100,link:a.item.uri,player:!0,width:100};switch(c){case "PLAYLIST_PUBLISHED":case "PLAYLIST_SUBSCRIBED":case "MY_PLAYLIST_SUBSCRIBED":case "PLAYLIST_SHARED":c=a.item.name;g.linkTypeHelper.isStarredPlaylist(a.item.uri)&&(c=q("starredTracks"));g.linkTypeHelper.isToplist(a.item.uri)&&(c=q("topTracks"));c=g.createLinkHelper(a.item.uri,
c);f.innerHTML=c;e=j.forPlaylist(a.item,e);f.appendChild(e.node);b.appendChild(f);break;case "TRACK_SHARED":c=g.createLinkHelper(a.item.uri,a.item.name);d=g.createLinkHelper(a.item.artists[0].uri,a.item.artists[0].name);c=h("by",c,d);f.innerHTML=c;e=j.forTrack(a.item,e);f.appendChild(e.node);b.appendChild(f);break;case "ALBUM_SHARED":c=g.createLinkHelper(a.item.uri,a.item.name);d=g.createLinkHelper(a.item.artists[0].uri,a.item.artists[0].name);c=h("by",c,d);f.innerHTML=c;e=j.forAlbum(a.item,e);f.appendChild(e.node);
b.appendChild(f);break;case "ARTIST_SHARED":c=g.createLinkHelper(a.item.uri,a.item.name),f.innerHTML=c,e=j.forArtist(a.item,e),f.appendChild(e.node),b.appendChild(f)}};var i={getType:function(a){switch(a.activityType){case "playlist-published":return a=a.item.uri.split(":")[2],m&&m.username===a?"PLAYLIST_PUBLISHED":n&&n.username===a?"MY_PLAYLIST_SUBSCRIBED":"PLAYLIST_SUBSCRIBED";case "playlist-track-added":return g.linkTypeHelper.isStarredPlaylist(a.item.uri)?"PLAYLIST_TRACK_STARRED":"PLAYLIST_TRACK_ADDED";
case "track-finished-playing":var b=a.referrer&&a.referrer.uri||"";return b&&-1!==b.indexOf(":app:radio",b.length-10)?"RADIO_TRACK_FINISHED_PLAYING":b&&-1!==b.indexOf("spotify:app",a.referrer.length-11)?"APP_TRACK_FINISHED_PLAYING":"TRACK_FINISHED_PLAYING";case "app-added":return"APP_ADDED";case "track-started-playing":return"UNKNOWN";case "uri-shared":return g.linkTypeHelper.isTrack(a.item.uri)?"TRACK_SHARED":g.linkTypeHelper.isPlaylist(a.item.uri)?"PLAYLIST_SHARED":g.linkTypeHelper.isAlbum(a.item.uri)?
"ALBUM_SHARED":g.linkTypeHelper.isArtist(a.item.uri)?"ARTIST_SHARED":"UNKNOWN";case "artist-followed":return"ARTIST_FOLLOWED";default:return"UNKNOWN"}}};exports.Activity=d});
