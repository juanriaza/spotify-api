require("scripts/profile-utils scripts/relations-helper#RelationsHelper scripts/controller#Controller scripts/logger#Logger $api/hermes $api/i18n $api/models $api/toplists#Toplist $views/image#Image $views/buttons $views/popup#Popup $views/utils/dom $views/utils/css strings/main.lang".split(" "),function(p,e,q,b,k,i,l,r,m,j,s,t,u,n){var g={container:".app-header",imageContainer:".header-image-container",mainContent:".header-content",buttonsContainer:".buttons-container",relationsInfoContainer:".relations-info",
listeningToContent:".listening-to-content",relationsPopover:"#relations-popover",avatarContainer:"#following-avatars",followersAmountContainer:"#followers-amount",followingAmountContainer:"#following-amount"},h=SP.bind(n.get,n),b=function(){this.init()};SP.inherit(b,q);b.prototype.initialize=function(a,c,f,d,b){this.setName("Header");this.setTemplates(f);this.container=document.querySelector(g.container);c?(this.isSelf=a,this.user=c,this.toplists=r.forUser(this.user),this.context=b,this.buttonHandlers=
d||{},this.render()):this.renderUnknownUser()};b.prototype.render=function(){document.querySelector(g.container).innerHTML=this.templates.header({profile:{classname:this.user.artist?"verified-badge":"",name:decodeURIComponent(this.user.name),uri:this.user.uri}});this.renderImage();this.getTopArtists();this.isSelf||this.renderButtons();this.user.artist?this.renderArtistInfo():this.renderRelationType();this.requestRelationsData()};b.prototype.renderUnknownUser=function(){document.querySelector(g.container).innerHTML=
this.templates.header({profile:{classname:"",name:h("unknownUser"),uri:""}});this.renderImage()};b.prototype.setTemplates=function(a){this.templates=a};b.prototype.renderRelationType=function(){var a="",c=this.container.querySelector(".info"),f=this;if(!1===this.isSelf){var d=k.Schema.fromURL("proto/socialgraph.proto");k.Hermes.get("hm://socialgraph/subscribers/exists",[d.type("StringListReply")],[d.type("StringListRequest")]).send({args:[this.user.username]}).done(function(d){"True"===d[0].reply[0]&&
(a=h("followsYou"),f.renderSendMusicButton.call(f));c.innerHTML=a}).fail(function(a){console.error("(HeaderController.renderRelationType) relation lookup fail",a)})}};b.prototype.renderArtistInfo=function(){var a=this.container.querySelector(".info"),c=this.user.artist.uri,f=j.CustomButton.withClass("view-link",h("viewDiscography"));this.events.listen(f,"click",function(){l.application.openURI(c)});a.appendChild(f.node)};b.prototype.getTopArtists=function(){this.toplists.load("artists").done(this.loadArtistsSnapshot.bind(this))};
b.prototype.loadArtistsSnapshot=function(){this.toplists.artists.snapshot(0,6).done(this.resolveArtistSnapshot.bind(this))};b.prototype.resolveArtistSnapshot=function(a){if(a.range.length){for(var c=[],f=0;f<a.range.length;f++)c.push(a.get(f).load("name"));l.Promise.join(c).always(this.renderTopArtistsText)}};b.prototype.renderImage=function(){var a=document.querySelector(g.imageContainer),c=m.forUser(this.user?this.user:"",{animate:!0,height:128,placeholder:"user",width:128});a.appendChild(c.node)};
b.prototype.renderTopArtistsText=function(a){for(var c=document.querySelector(g.listeningToContent),f=h("listeningTo")+" ",d=0;d<a.length;d++)if(void 0!==a[d].name)var b=p.createLinkHelper(a[d].uri,a[d].name),f=d===a.length-1?f+(b+"."):f+(b+", ");c.innerHTML=f};b.prototype.renderButtons=function(){var a=document.querySelector(g.buttonsContainer),c=j.SubscribeButton.forUser(this.user);a.appendChild(c.node)};b.prototype.renderSendMusicButton=function(){var a=document.querySelector(g.buttonsContainer),
c=j.Button.withLabel(h("sendMusic"));"function"===typeof this.buttonHandlers.share&&this.events.listen(c,"click",this.buttonHandlers.share.bind(this.context,c));a.appendChild(c.node)};b.prototype.avatarOverHandler=function(a){var c=a.target.parentNode.getAttribute("data-tooltip");this.popup?this.popup.setText(c):this.popup=s.withText(c);this.popup.showFor(a.target)};b.prototype.avatarOutHandler=function(){this.popup.hide()};b.prototype.requestRelationsData=function(){this.log("requesting relations data");
e.initialize(this.user,this.isSelf);this.events.listen(e,"all_relations_loaded",this.relationsLoadComplete);e.requestRelations()};b.prototype.relationsLoadComplete=function(a){this.log("relations has loaded",a,this.isSelf);this.events.unlisten(e,"all_relations_loaded",this.relationsLoadComplete);var c=document.querySelector(g.relationsInfoContainer),b=encodeURIComponent(this.user.username).replace(/\!/g,"%21");c.innerHTML=this.templates.relationsInfo({followersHeading:h("followers"),followersAmount:i.number(a.data.numSubscribers),
followersAmountUnformatted:a.data.numSubscribers,followingHeading:h("following"),followingAmount:i.number(a.data.numSubscriptions),followingAmountUnformatted:a.data.numSubscriptions,userUriFollowers:("spotify:user:"+b+":followers").toSpotifyLink(),userUriFollowing:("spotify:user:"+b+":following").toSpotifyLink()});this.isSelf?this.events.listen(e,"subscribers_add",function(){this.updateNumber(1,"followers")}).listen(e,"subscribers_remove",function(){this.updateNumber(-1,"followers")}).listen(e,"subscriptions_add",
function(){this.updateNumber(1,"following");this.renderFacepile()}).listen(e,"subscriptions_remove",function(){this.updateNumber(-1,"following");this.renderFacepile()}):this.events.listen(e,"subscribers_change",function(a){this.updateNumber(a.data.oldValue?-1:1,"followers")});this.facepileData={};this.renderFacepile()};b.prototype.renderFacepile=function(){e.relations[e.subscriptionCollection].snapshot(0,3).done(this,function(a){var c,b,d,e,h,i=document.querySelector(g.avatarContainer),j=a.toArray(),
a=this.facepileData;this.facepileData={};c=0;for(b=j.length;c<b;c++)d=j[c],d.uri in a?(this.facepileData[d.uri]=a[d.uri],delete a[d.uri]):(e={animate:!0,height:36,width:36,link:d.uri},e=m.forProfile(d,e),this.facepileData[d.uri]={item:d,image:e},this.events.listen(e.node,"mouseover",this.avatarOverHandler).listen(e.node,"mouseout",this.avatarOutHandler),i.appendChild(e.node));for(h in a)c=a[h].image.node,i.removeChild(c),this.events.unlisten(c,"mouseover"),this.events.unlisten(c,"mouseout")})};b.prototype.updateNumber=
function(a,c){this.log("updating number",a,c);var b=document.querySelector(g[c+"AmountContainer"]);if(b){var d=parseInt(b.getAttribute("data-"+c+"-amount")),d=Math.max(0,d+a);b.innerHTML=i.number(d);b.setAttribute("data-"+c+"-amount",d)}};exports.Header=b});
