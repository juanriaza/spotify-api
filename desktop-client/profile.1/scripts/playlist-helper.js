require(["scripts/profile-utils","$shared/events#EventHandler"],function(L,D){var u=function(a){"object"!=typeof a&&(a={});this.data={sortIndex:a.hasOwnProperty("sortIndex")?a.sortIndex:0,identifier:a.hasOwnProperty("identifier")?a.identifier:(new Date).getTime(),dataObj:a.hasOwnProperty("dataObj")?a.dataObj:{}}};u.prototype={getIdentifier:function(){return this.data.identifier},getDataObject:function(){return this.data.dataObj},getSortIndex:function(){return this.data.sortIndex},setSortIndex:function(a){this.data.sortIndex=
a}};var i,c=[],r;i={setIdentifier:function(a){a&&"string"===typeof a&&(r=a)},addItem:function(a,s){a&&(c[c.length]=new u({dataObj:a,sortIndex:s,identifier:a.hasOwnProperty(r)?a[r]:null}))},init:function(){c=[]},length:function(){return c.length},getItemByIndex:function(a){return!a&&"number"!=typeof a?null:c[a]},getItemByIdentifier:function(a){if(!a&&"string"!=typeof a)a=null;else{for(var s=c,b=0,d=c.length,g=-1;b<d;b++)if(c[b].getIdentifier()===a){g=b;break}a=s[g]}return a},getItems:function(){return c},
sort:function(){c.sort(function(a,b){return a.getSortIndex()-b.getSortIndex()});for(var a=0,b=c.length;a<b;a++)c[a].setSortIndex(a)}};var j,e=null,b=null,m=null,f=!1,h=null,k=0,d=null,q=0,t=0,n=0,l=null,v=function(){d.toplist.load("name","owner","subscribers","tracks").done(E).fail(p)},I=function(){e||(e=new D(this));l&&clearTimeout(l);l=setTimeout(w,500);b&&(b.onInsert&&f?e.listen(d.playlists,"insert",x):b.onInsert&&!f&&e.listen(d.published,"insert",x),b.onRemove&&f&&e.listen(d.playlists,"remove",
F),b.onPublishedInsert&&f&&e.listen(d.published,"insert",G),b.onPublishedRemove&&f&&e.listen(d.published,"remove",H))},x=function(a){m=a.uris;b.onInsert&&"function"===typeof b.onInsert&&b.onInsert.call(null,a);l&&clearTimeout(l);l=setTimeout(w,500)},F=function(a){m=a.uris;b.onRemove&&"function"===typeof b.onRemove&&b.onRemove.call(null,a)},G=function(a){m=a.uris;b.onPublishedInsert&&"function"===typeof b.onPublishedInsert&&b.onPublishedInsert.call(null,a)},H=function(a){m=a.uris;b.onPublishedRemove&&
"function"===typeof b.onPublishedRemove&&b.onPublishedRemove.call(null,a)},J=function(a){h.push(a);v()},E=function(a){a.tracks.snapshot().done(K.bind(a)).fail(p)},K=function(a){0<a.length&&h.push(this);p()},p=function(){f?d.playlists.snapshot(k,200).done(y).fail(function(a,b){console.error("(PlaylistHelper) playlist snapshot failed",a,b)}):d.published.snapshot(k,200).done(y).fail(function(a,b){console.error("(PlaylistHelper) playlist snapshot failed",a,b)})},y=function(a){var b=0;if(a.length){if(!n){n=
a.length;i.init();for(b=0;b<h.length;b++)i.addItem(h[b],b-1+h.length),z()}q=a.range.length;for(b=0;b<q;b++){var d=k+b,c=a.get(d);c&&i.addItem(c,d+h.length);z()}k+=q;k<n?p():0===a.length&&A()}else A()},A=function(){console.info("(PlaylistHelper) no playlists for user");j&&"function"===typeof j&&j.call(this,B())},z=function(){t++;t===n+h.length&&j&&"function"===typeof j&&j.call(this,B())},B=function(){var a=0,b=i.length(),d=[],c;for(i.sort();a<b;a++){c=i.getItemByIndex(a);var g;if(g=c){a:{g=c.getIdentifier();
for(var e=d,f=0,h=e.length;f<h;f++)if(e[f].getIdentifier()===g){g=!0;break a}g=!1}g=!g}g&&d.push(c)}return d},C=function(){n=t=q=k=0;i.init();i.setIdentifier("uri")},w=function(){C();h=[];f?d.starred.load("name","owner","subscribers").done(J).fail(v):p()};exports.registerCallback=function(a){a&&"function"==typeof a&&(j=a)};exports.load=function(a){C();f=a;d||console.error("(PlaylistHelper) no library set!");try{I()}catch(b){console.error(b)}};exports.destroy=function(){e&&e.removeAll()};exports.setLibrary=
function(a){a&&(d=a)};exports.getLatestChange=function(){return m};exports.registerEventHandlers=function(a){a&&"object"==typeof a&&(b=a)}});
