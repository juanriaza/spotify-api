require("scripts/profile-utils scripts/playlist-helper scripts/controller#Controller scripts/context-menu scripts/logger#Logger $api/i18n $api/library#Library $api/models#Playlist $api/models#Promise $api/models#application $views/list#List $views/image#Image $views/buttons#SubscribeButton $views/buttons#CustomButton $views/throbber#Throbber $views/utils/css strings/playlist.lang".split(" "),function(i,k,s,p,t,u,v,b,x,y,z,q,A,r,B,h,w){var f=SP.bind(w.get,w),b=function(){this.scrollHandler=this.scrollHandler.bind(this);
this.show=this.show.bind(this);this.hide=this.hide.bind(this);this.init()};SP.inherit(b,s);b.prototype.initialize=function(a,c,d,e,g){this.playlists=null;this.batchindex=0;this.user=c;this.templates=d;this.isSelf=a;this.container=document.querySelector(".app-playlists");this.renderedPlaylistsByIndex=[];this.renderHeader();this.doneCallback=e||null;this.externalScope=g||null;k.registerCallback(this.playlistsLoaded.bind(this));this.library=a?v.forCurrentUser():v.forUser(this.user);k.setLibrary(this.library);
k.registerEventHandlers({onInsert:!0,onRemove:this.updateOnRemove.bind(this),onPublishedInsert:a?this.updateOnPublishedInsert.bind(this):!0,onPublishedRemove:a?this.updateOnPublishedRemove.bind(this):!0});k.load(a,g.session)};b.prototype.playlistsLoaded=function(a){console.log("(PlaylistController.playlistsLoaded) playlists loaded:",a.length);this.removeNoPlaylistMessage();a.length?(this.playlists=a,this.render()):this.renderNoPlaylistsMessage();this.doneCallback&&"function"===typeof this.doneCallback&&
this.doneCallback.call(this.externalScope||this)};b.prototype.renderNoPlaylistsMessage=function(){var a;this.throbber.isActive&&this.throbber.hide();this.isSelf?a=f("currentUserNoPlaylists"):(a=i.userFirstName(this.user),a=f("userNoPlaylists",a));var c=document.createElement("div");h.addClass(c,"no-playlists");h.addClass(c,"apply-width");c.innerHTML=this.templates.empty_message({message:a});this.container.querySelector(".playlists").appendChild(c)};b.prototype.removeNoPlaylistMessage=function(){var a=
this.container.querySelector(".no-playlists");a&&a.parentNode.removeChild(a)};b.prototype.render=function(){this.loadBatch()};b.prototype.renderHeader=function(){this.container.innerHTML=this.templates.playlists({playlists:{heading:f("playlistsHeading")}});this.throbber=B.forElement(this.container.querySelector(".playlists"));this.throbber.setPosition(0,0)};b.prototype.scrollHandler=function(a){this.timer&&clearTimeout(this.timer);a>=this.lastScrollY&&(this.playlists&&this.renderedPlaylistsByIndex.length<
this.playlists.length)&&(this.timer=setTimeout(this.loadBatch.bind(this),100));this.lastScrollY=a};b.prototype.loadBatch=function(){if(this.playlists){var a,c=this.playlists.length,d=0===this.batchindex?5:this.batchindex+3,e=this;SP.analyticsContext("PLAYLISTS: loading a batch of playlists",function(){for(a=e.batchindex;a<d&&a<c;a++)e.preRenderPlaylist(a);e.batchindex=d})}};b.prototype.preRenderPlaylist=function(a){var c=this.playlists[a];if(c){var d=c.getIdentifier();-1<d.indexOf(this.user.username+
":publishedstarred")?console.log("(PlaylistController.render) skipping",d):this.getPlaylist(c.getDataObject(),a);this.renderedPlaylistsByIndex.push(a)}};b.prototype.getPlaylist=function(a,c){var d=this;SP.analyticsContext("PLAYLIST: load playlist",function(){a.load("name","owner","subscribers","published","collaborative").done(function(a){d.getPlaylistOwner(a,c)}).fail(function(){console.error("(PlaylistController.getPlaylist) playlist failed to load",arguments)})})};b.prototype.getPlaylistOwner=
function(a,c){var d=this;SP.analyticsContext("PLAYLIST: load playlist owner",function(){a.owner.load("name","username","currentUser").done(function(){d.getPlaylistSnapshot(a,c)}).fail(function(){d.getPlaylistSnapshot(a,c)})})};b.prototype.getPlaylistSnapshot=function(a,c){a.tracks.snapshot(0,0).done(this.renderPlaylist.bind(this,a,c)).fail(this.renderPlaylist.bind(this,a,c))};b.prototype.isOwnPlaylist=function(a){return a.owner.currentUser&&this.isSelf||a.owner.username===this.user.username};b.prototype.renderPlaylist=
function(a,c,d){var e=document.createElement("article"),g=i.linkTypeHelper.isStarredPlaylist(a.uri),b=i.linkTypeHelper.isToplist(a.uri),l,j;if(!(g&&0===d.length)){e.setAttribute("id","playlist-"+c);e.setAttribute("data-uri",a.uri);e.setAttribute("data-index",c);j=g?this.isOwnPlaylist(a)?i.createLinkHelper(a.uri,f("starredTracks")):i.createLinkHelper(a.uri,f("starredTracks"))+" <span>"+f("by")+"</span> "+i.createLinkHelper(a.owner.uri,a.owner.name):b?this.isOwnPlaylist(a)?i.createLinkHelper(a.uri,
f("topTracks")):i.createLinkHelper(a.uri,f("topTracks"))+" <span>"+f("by")+"</span> "+i.createLinkHelper(a.owner.uri,a.owner.name):this.isOwnPlaylist(a)?i.createLinkHelper(a.uri,a.name):i.createLinkHelper(a.uri,a.name)+" <span>"+f("by")+"</span> "+i.createLinkHelper(a.owner.uri,a.owner.name);h.addClass(e,"playlist");h.addClass(e,"apply-width");e.innerHTML=this.templates.playlist({playlist:{title:""+j}});j={animate:!0,height:128,width:128,placeholder:"playlist",playerItem:a,player:!0,link:a.uri};l=
g?q.fromSource("img/starred.png",j):b?q.fromSource("img/toptracks.png",j):q.forPlaylist(a,j);g=z.forPlaylist(a,{context:a,type:"tracks",fields:"star share track artist time album popularity".split(" "),header:"yes",unplayable:"hidden",numItems:5});j=e.querySelector(".playlist-buttonview");var k=A.forPlaylist(a),m,b=this.isSelf&&!a.collaborative&&!b;e.querySelector(".playlist-image").appendChild(l.node);this.listenToFollowbutton(k,a.uri);b&&(m=a.published?r.withClass("playlist-publishbutton playlist-publishbutton-public",
f("public")):r.withClass("playlist-publishbutton playlist-publishbutton-secret",f("secret")),e.querySelector(".playlist-image").appendChild(m.node));a.collaborative&&(l=e.querySelector(".playlist-icon"),h.addClass(l,"collaborative"));e.querySelector(".playlist-listview").appendChild(g.node);a.owner.currentUser||(j.appendChild(k.node),j.style.paddingLeft=k.offsetWidth+10+"px");this.insertPlaylistNode(e,c,a);this.getPlaylistPopcount(e,j,a);this.renderMoreButton(e,a,d.length);if(b){var n=new p.ContextMenu;
n.setOptions(this.createPublishOptions(a,m.node,n));this.events.listen(m.node,"mouseover",function(){n.setElements(m.node,e.querySelector(".playlist-image"));n.show(m.node)})}g.init()}};b.prototype.listenToFollowbutton=function(a,c){var d=this;this.events.listen(a,"subscribe",function(){t.log({type:"subscribeToPlaylist",uri:c});d.updatePopcount(!0,c)});this.events.listen(a,"unsubscribe",function(){t.log({type:"unsubscribeFromPlaylist",uri:c});d.updatePopcount(!1,c)})};b.prototype.renderMoreButton=
function(a,c,d){var e=r.withClass("playlist-morebutton",f("seeAllTracks"));d&&1<d&&(this.events.listen(e,"click",function(){y.openURI(c.uri)}),a.appendChild(e.node))};b.prototype.getPlaylistPopcount=function(a,c,d){var e=this;SP.analyticsContext("PLAYLIST: loading subscribers",function(){d.subscribers.snapshot(0,10).done(function(d){e.resolveUserPromises(a,c,d)})})};b.prototype.resolveUserPromises=function(a,c,d){for(var e=0,g=d.range.length,b=[],f=this;e<g;e++)b.push(d.get(e).load("name","username",
"uri"));x.join(b).done(function(e){f.renderFollowerMarkup(a,c,e,d.length)}).fail(function(){f.renderFollowerMarkup(a,c,null,d.length)})};b.prototype.renderFollowerMarkup=function(a,c,d,e){var g=[],b=null,l,j=c.querySelector(".sp-button-subscribe");a.querySelector(".playlist-followers").innerHTML=this.templates.playlistfollowers({playlist:{followersText:f("followers"),popcount:u.number(e)}});a.setAttribute("data-popcount",e);if(d&&d.length){e=a=0;for(b=d.length;a<b&&5>e;a++)/^\d+$/.test(d[a].name)||
(g.push(i.createLinkHelper(d[a].uri,d[a].name)),e++);b=g.join(", ");b+=".";l=document.createElement("p");h.addClass(l,"playlist-followers-container");j&&(c.style.paddingLeft=j.offsetWidth+10+"px")}b&&(l.innerHTML=f("followedBy",b),c.appendChild(l))};b.prototype.updatePopcount=function(a,c,d){var d=d?d:1,c=this.container.querySelector('[data-uri="'+c+'"]'),e=c.querySelector(".popcount-value"),b=parseInt(c.getAttribute("data-popcount"),10);a?b+=d:(b-=d,b=0>b?0:b);e.innerText=u.number(b);c.setAttribute("data-popcount",
b)};b.prototype.removeElement=function(a){var c=this;h.addClass(a,"element-hide");var d=setTimeout(function(){h.addClass(a,"hidden");var e=c.container.querySelector(".playlists"),b=e.querySelectorAll(".element-hide");if(e&&b.length)for(var f=0,l=b.length;f<l;f++)e.removeChild(b[f]);clearTimeout(d)},500)};b.prototype.insertPlaylistNode=function(a,c,d){var b=this.container.querySelector(".playlists"),g=document.createElement("hr"),f=b.querySelectorAll(".playlist"),h=f.length,j=0,i=0;g.setAttribute("data-divider-for",
d.uri);if(0===h||f[h-1].getAttribute("data-index")<c)b.appendChild(a),b.appendChild(g);else for(;j<h;j++)f[j].getAttribute("data-index")<c&&i++,b.insertBefore(a,f[i]),b.insertBefore(g,f[i]);this.throbber.isActive&&this.throbber.hide()};b.prototype.destroy=function(){k.destroy();s.prototype.destroy.call(this)};b.prototype.updateOnRemove=function(){for(var a=k.getLatestChange(),c,b,e=0,f=a.length;e<f;e++)c=this.container.querySelector('[data-uri="'+a[e]+'"]'),b=this.container.querySelector('[data-divider-for="'+
a[e]+'"]'),c&&this.removeElement(c),b&&this.removeElement(b)};b.prototype.updateOnPublishedInsert=function(){for(var a=k.getLatestChange(),c,b=0,e=a.length;b<e;b++)if(c=this.container.querySelector('[data-uri="'+a[b]+'"]')){var g=c.getElementsByClassName("playlist-publishbutton")[0],i=c.getElementsByClassName("menu-item-public")[0];c=c.getElementsByClassName("menu-item-secret")[0];g.innerText=f("public");h.removeClass(g,"playlist-publishbutton-secret");h.addClass(g,"playlist-publishbutton-public");
h.removeClass(c,"active");h.addClass(i,"active")}};b.prototype.updateOnPublishedRemove=function(){for(var a=k.getLatestChange(),b,d=0,e=a.length;d<e;d++)if(b=this.container.querySelector('[data-uri="'+a[d]+'"]')){var g=b.getElementsByClassName("playlist-publishbutton")[0],i=b.getElementsByClassName("menu-item-public")[0];b=b.getElementsByClassName("menu-item-secret")[0];g.innerText=f("secret");h.removeClass(g,"playlist-publishbutton-public");h.addClass(g,"playlist-publishbutton-secret");h.removeClass(i,
"active");h.addClass(b,"active")}};b.prototype.createPublishOptions=function(a,b,d){var b=[],e=this,g=new p.ContextMenuItem({text:f("public"),cssClass:"menu-item-public",active:a.published,handler:function(){d.clearActive();h.addClass(this.element,"active");e.library.publish(a);d.close()}});b.push(g);g=new p.ContextMenuItem({text:f("secret"),cssClass:"menu-item-secret",active:!a.published,handler:function(){d.clearActive();h.addClass(this.element,"active");e.library.unpublish(a);d.close()}});b.push(g);
return b};b.prototype.getPlaylists=function(){return this.playlists||[]};exports.Playlists=b});
