require("scripts/profile-utils scripts/controller#Controller scripts/logger#Logger $api/i18n $api/models $api/relations#Relations $api/library#Library $views/image#Image $views/buttons#SubscribeButton $views/utils/css $views/throbber#Throbber $social-artist-shared/artist.relations#ArtistGraph scripts/relations-helper#RelationsHelper scripts/relations-helper#RelationTypes strings/relations.lang".split(" "),function(l,p,m,k,g,q,r,s,t,h,u,v,e,i,n){var f=SP.bind(n.get,n),j={subscriptionsContainer:".app-followers",
subscribersContainer:".app-following",avatar:".image-container",subscribers:"#followers-container",subscriptions:"#following-container",followButton:".follow-button-container"},c=function(){this.scrollHandler=this.scrollHandler.bind(this);this.init()};SP.inherit(c,p);c.prototype.initialize=function(a,b,d,c){this.setName(c);this.type=c;this.ltype=c.toLowerCase();this.renderedRelations=[];this.relations=[];this.retries={};this.user=a;this.isSelf=b;this.templates=d;this.container=document.querySelector(j[this.ltype+
"Container"]);this.allUsersLoaded=!1;this.initFlag=!0;this.refreshFlag=!1;this.throbberDiv=this.throbber=null;this.batchIndex=0};c.prototype.show=function(){var a=this;if(this.initFlag||this.refreshFlag)this.log("refreshing..."),this.allUsersLoaded=!1,this.batchIndex=0,this.renderedRelations=[],this.relations=[],this.retries={},this.throbberDiv=this.throbber=null,this.removeNoRelationsMessage(),this.destroy(),this.render(),this.initFlag&&(this.rangeEnd=parseInt(window.innerHeight/70,10)+2,this.initFlag=
!1),this.events.listen(e,this.ltype+"_loaded",this.relationsLoadComplete).listen(e,this.ltype+"_add",this.relationAdded).listen(e,this.ltype+"_remove",this.relationRemoved),!this.isSelf&&this.type===i.FOLLOWERS&&this.events.listen(e,"subscribers_change",this.subscriberChanged),this.relationContainer=document.querySelector(j[this.ltype]),SP.analyticsContext("RELATIONS: load "+this.type,function(){e["request"+a.type]()}),this.refreshFlag=!1;c._superClass.show.call(this)};c.prototype.render=function(){this.log("render: call to render "+
this.type,this.templates);this.container.innerHTML=this.templates[this.ltype].call(this);this.showLoader()};c.prototype.relationsLoadComplete=function(a){this.log("finished loading "+this.type,a,this.relations);this.relations=a.data.loaded;0===this.relations.length?(this.renderNoRelationsMessage(),this.hideLoader()):this.createRelations(this.rangeEnd)};c.prototype.createRelations=function(a){var b=this.batchIndex,d=this.relations.length,a=a||5,c=b+a;for(this.log("rendering from "+b+" to "+(b+a),d);b<
c&&b<d;b++)this.renderRelation(g.Profile.fromURI(this.relations[b].uri));this.batchIndex+=a};c.prototype.relationRemoved=function(a){this.log("collection remove "+this.type,a);this.refreshFlag=!0};c.prototype.relationAdded=function(a){this.log("collection add "+this.type,a);this.refreshFlag=!0;a.data&&a.data.uri&&this.appendRelation(a.data.uri)};c.prototype.subscriberChanged=function(a){var b=g.session.user.username||null;b&&(a.data&&a.data.oldValue?this.removeRelation("spotify:user:"+b):a.data&&
!a.data.oldValue&&this.appendRelation("spotify:user:"+b))};c.prototype.removeRelation=function(a){var b=this.container.querySelector("[data-"+this.ltype+'-uri="'+a+'"]');a&&b&&(a=this.renderedRelations.indexOf(a),this.renderedRelations.splice(a,1),this.refreshFlag=!0,this.relationContainer.removeChild(b),0===this.renderedRelations.length&&this.renderNoRelationsMessage())};c.prototype.appendRelation=function(a){var b=this.container.querySelector("[data-"+this.ltype+'-uri="'+a+'"]');a&&(!b&&l.linkTypeHelper.isUser(a))&&
(this.refreshFlag=!0,b=g.User.fromURI(a),this.relations.push(b),this.renderRelation(g.Profile.fromURI(a)),this.removeNoRelationsMessage())};c.prototype.hideLoader=function(){this.throbber&&this.throbber.isActive&&this.throbber.hide()};c.prototype.showLoader=function(){this.throbber?this.throbber&&!this.throbber.isActive&&this.throbber.show():(this.throbberDiv=document.createElement("div"),this.container.appendChild(this.throbberDiv),this.throbber=u.forElement(this.throbberDiv),this.throbber.setPosition(0,
0))};c.prototype.renderNoRelationsMessage=function(){if(!(0<this.container.querySelectorAll(".empty-message").length)){var a;if(this.isSelf)this.type===i.FOLLOWING?a=f("currentUsernoFollowingMessage"):this.type===i.FOLLOWERS&&(a=f("currentUsernoFollowersMessage"));else{var b=l.userFirstName(this.user);this.type===i.FOLLOWING?a=f("noFollowingMessage",b):this.type===i.FOLLOWERS&&(a=f("noFollowersMessage",b))}b=document.createElement("div");h.addClass(b,"apply-width");b.innerHTML=this.templates.empty_message({message:a});
document.querySelector(j[this.ltype]).appendChild(b)}};c.prototype.removeNoRelationsMessage=function(){var a=this.container.querySelector(".empty-message");a&&(a.parentNode.removeChild(a),this.hideLoader())};c.prototype.scrollHandler=function(a){this.scrollTimer&&clearTimeout(this.scrollTimer);a>=this.lastScrollY&&!1===this.allUsersLoaded&&(this.scrollTimer=setTimeout(this.createRelations.bind(this),50));this.lastScrollY=a};c.prototype.makeLink=function(a,b){a.href=b;this.events.listen(a,"click",
function(a){g.application.openURI(b);a.preventDefault();a.stopPropagation()})};c.prototype.renderRelation=function(a){a.load("user","artist","name","image").done(this,this.addRelation).fail(this,this.relationLoadFail)};c.prototype.addRelation=function(a){if(-1<this.renderedRelations.indexOf(a.uri))this.log("relation already rendered",a);else{var b=document.createElement("div");h.addClass(b,"relation-wrapper");b.setAttribute("data-"+this.ltype+"-uri",a.uri);b.innerHTML=this.templates.subscribee();
var d=document.createElement("a");h.addClass(d,"friend-name");d.innerText=a.name;this.makeLink(d,a.uri);b.querySelector(".friend-info").appendChild(d);d=s.forProfile(a,{animate:!1,height:50,style:"inset",width:50,link:a.uri});b.querySelector(j.avatar).appendChild(d.node);this.relationContainer.appendChild(b);(d=a.user)?d.load("currentUser").done(this,function(){this._renderFollowButtonIfNecessary(b,a)}):this._renderFollowButtonIfNecessary(b,a);a.artist?(d=document.createElement("span"),h.addClass(d,
"follower-badge"),a.user&&h.addClass(d,"verified-artist"),d.innerText=f("artist").toUpperCase(),b.querySelector(".friend-info").appendChild(d),this.loadArtistFollowers(a.artist)):(this.loadUserFollowers(a),this.loadRelationPlaylist(d));this.renderedRelations.push(a.uri);this.renderedRelations.length===this.relations.length&&(this.log("addUser: wont load more relations",this.renderedRelations.length),this.allUsersLoaded=!0,this.hideLoader())}};c.prototype._renderFollowButtonIfNecessary=function(a,
b){if(!b.user||!b.user.currentUser){var d=t.forProfile(b.user||b.artist);this.events.listen(d,"subscribe",function(){m.log({type:"subscribeToFollower",uri:b.uri});this.updateFollowerCount(!0,b.uri);this.log("subscribing",e)});this.events.listen(d,"unsubscribe",function(){m.log({type:"unsubscribeFromFollower",uri:b.uri});this.updateFollowerCount(!1,b.uri);this.log("unsubscribing",e)});a.querySelector(j.followButton).appendChild(d.node)}};c.prototype.loadUserFollowers=function(a){q.forUser(a.user).load("subscribers").done(this,
function(b){this.resolveRelationFollowers(a,b)}).fail(this,function(b,d){this.relationFollowersFailed(a,d)})};c.prototype.resolveRelationFollowers=function(a,b){b.subscribers.snapshot(0,0).done(this,function(b){this.appendRelationFollowers(a,b.length)}).fail(this,function(b,c){this.relationFollowersFailed(a,c)})};c.prototype.appendRelationFollowers=function(a,b){var d=a.user?a.user.uri:a.artist.uri,c=document.querySelector("[data-"+this.ltype+'-uri="'+d+'"]'),e=document.createElement("a");c.setAttribute("data-"+
this.ltype+"-count",b);e.innerText=1===b?f("followerCountSingle",b):f("followerCountPlural",k.number(b));a.user&&this.makeLink(e,d+":followers");c.querySelector(".friend-num").appendChild(e)};c.prototype.loadArtistFollowers=function(a){v.forArtist(a.uri).load("subscriber_count").done(this,this.graphLoaded.bind(this,a)).fail(this,this.graphLoadFail)};c.prototype.graphLoaded=function(a,b){g.Profile.fromURI(a.uri).load("user").done(this,function(a){this.appendRelationFollowers(a,b.subscriber_count)})};
c.prototype.graphLoadFail=function(a){console.error("(RelationsController) graphLoadFail:",a)};c.prototype.loadRelationPlaylist=function(a){r.forUser(a).published.snapshot(0,0).done(this,function(b){this.appendRelationPlaylists(a,b.length)}).fail(this,function(b,d){this.relationPlaylistsFailed(a,d)})};c.prototype.appendRelationPlaylists=function(a,b){var d=document.querySelector("[data-"+this.ltype+'-uri="'+a.uri+'"]'),c=document.createElement("a");c.innerText=1===b?f("playlistCountSingle",b):f("playlistCountPlural",
k.number(b));this.makeLink(c,a.uri);d.querySelector(".playlist-num").appendChild(c)};c.prototype.relationLoadFail=function(a,b){this.log("failed to load",a,b);var d=this.retries.relationLoadFail;!d||3>d?(this.retries.relationLoadFail=!d?1:d+1,this.renderRelation(a)):(console.log("(RelationsController) relationLoadFail failed",a,b),d=this.relations.indexOf(a),this.relations.splice(d,1))};c.prototype.relationFollowersFailed=function(a,b){this.log("relation followers failed to load",a,b);var d=this.retries.relationFollowersFailed;
!d||3>d?(this.retries.relationFollowersFailed=!d?1:d+1,this.loadUserFollowers(a)):console.log("(RelationsController) relationFollowersFailed failed",b)};c.prototype.relationPlaylistsFailed=function(a,b){this.log("playlists failed to load",a,b);var d=this.retries.relationPlaylistsFailed;!d||3>d?(this.retries.relationPlaylistsFailed=!d?1:d+1,this.loadRelationPlaylist(a)):console.log("(RelationsController) relationPlaylistsFailed failed",b)};c.prototype.updateFollowerCount=function(a,b,d){this.log("updateFollowingCount",
a,b,d);d=d?d:1;if(b=this.container.querySelector("[data-"+this.ltype+'-uri="'+b+'"]')){var c=parseInt(b.getAttribute("data-"+this.ltype+"-count"),10);a?c+=d:(c-=d,c=0>c?0:c);b.setAttribute("data-"+this.ltype+"-count",c);b.querySelector(".friend-num").innerText=1!==c?f("followerCountPlural",k.number(c)):f("followerCountSingle",c)}};exports.Relations=c});
