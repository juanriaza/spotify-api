require("scripts/controller#Controller $api/i18n $api/toplists#Toplist $api/models#Promise $api/models#Playlist $api/library#Library $views/image#Image $views/throbber#Throbber $views/utils/css strings/playlist.lang".split(" "),function(i,j,k,l,b,g,m,n,p,h){var f=SP.bind(h.get,h),b=function(){this.init()};SP.inherit(b,i);b.prototype.initialize=function(a,c,d,b){this.user=c;this.isSelf=a;this.templates=d;this.container=document.querySelector(".app-toplists");this.topPlaylists=[];this.toplists=[];this.playlistCache=
[];this.popcounts={};this.progress=0;b?this.parsePlaylists(b):this.loadLibrary()};b.prototype.parsePlaylists=function(a){a.map(this.transformIndexItem,this);this.loadPlaylists(this.playlistCache.length)};b.prototype.transformIndexItem=function(a){this.playlistCache.push(a.getIdentifier())};b.prototype.loadLibrary=function(){this.library=this.isSelf?g.forCurrentUser():g.forUser(this.user);this.library.published.snapshot(0,0).done(this,this.resolveLibrarySnapshot).fail(this,this.destroy)};b.prototype.resolveLibrarySnapshot=
function(a){for(var c=0,d=a.length;c<d;c++)this.playlistCache.push(a.get(c).uri);this.loadPlaylists(a.length)};b.prototype.loadPlaylists=function(a){if(3<a){var c=this;SP.analyticsContext("TOPLISTS: loading Toplist.forUser",function(){k.forUser(c.user).load("playlists").done(c.takePlaylistsSnapshot.bind(c))})}else console.log("(ToplistsController.loadPlaylists) not enough playlists",a),this.destroy()};b.prototype.takePlaylistsSnapshot=function(a){a.playlists.snapshot(0,5).done(this,this.resolveSnapshot)};
b.prototype.resolveSnapshot=function(a){for(var c=0,d=a.range.length,b=[];c<d;c++)b.push(a.get(c).load("name","image","subscribers","uri"));l.join(b).each(this,this.addResolvedPlaylist).always(this,this.playlistsLoaded)};b.prototype.addResolvedPlaylist=function(a){this.topPlaylists.push(a)};b.prototype.playlistsLoaded=function(){var a=0,c=this.topPlaylists.length;for(this.progress=c;a<c;a++)this.loadSubscribersForPlaylist(this.topPlaylists[a])};b.prototype.render=function(){for(var a=0,c=this.topPlaylists.length,
b,e;a<c;a++)b=this.topPlaylists[a],this.popcounts.hasOwnProperty(b.uri)&&!(0>this.playlistCache.indexOf(b.uri))&&(e=this.popcounts[b.uri],0>=e||this.toplists.push({playlist:b,popcount:e}));this.toplists.sort(this.sortList);console.log("(ToplistController.render) found playlists in toplists",this.toplists.length);if(3<this.toplists.length)this.container.innerHTML=this.templates.toplists({toplists:{heading:f("topPlaylistsHeading")}}),this.throbber=n.forElement(this.container),this.renderPlaylists();
else return console.log("(ToplistsController.render) not enough playlists in toplist",this.toplists.length),this.destroy(),!1};b.prototype.sortList=function(a,b){return b.popcount-a.popcount};b.prototype.renderPlaylists=function(){for(var a=0,b=this.toplists.length;a<b;a++)this.renderPlaylist(this.toplists[a].playlist,this.toplists[a].popcount)};b.prototype.loadSubscribersForPlaylist=function(a){var b=this;SP.analyticsContext("TOPLISTS: loading playlist subscribers",function(){a.subscribers.load().done(function(d){b.loadSubscribersSnapshot(d,
a)})})};b.prototype.loadSubscribersSnapshot=function(a,b){var d=this;a.snapshot(0,0).done(function(a){d.popcounts[b.uri]=a.length;d.progress--;0===d.progress&&d.render()})};b.prototype.renderPlaylist=function(a,b){var d=document.createElement("div"),e=j.number(b);p.addClass(d,"playlist");d.setAttribute("data-popcount",b);d.innerHTML=this.templates.toplistplaylist({playlist:{name:a.name.decodeForHtml(),uri:a.uri,followers:1===b?f("followerCountSingle","<strong>"+e+"</strong>"):f("followerCountPlural",
"<strong>"+e+"</strong>")}});e=m.forPlaylist(a,{animate:!0,height:128,width:128,player:!0,link:a.uri});d.querySelector(".playlist-image").appendChild(e.node);this.throbber.isActive&&this.throbber.hide();this.appendPlaylistNode(d)};b.prototype.appendPlaylistNode=function(a){this.container.querySelector(".top-playlists").appendChild(a)};exports.Toplists=b});
