exports.getIdentityPipe=function(a,c){return new PlayablePipe(a,c)};function PlayablePipe(a,c){this._array=a.slice(0);this._newTracksCallback=c;this._newTracksCalled=!1;this._queue=[];this._pendingCallback=null;this._retryCount=0}PlayablePipe.prototype.next=function(a){this._retryCount=0;this._next(a)};
PlayablePipe.prototype._next=function(a){console.log("PlayablePipe._next");5<this._retryCount?console.log("PlayablePipe._next too many retries"):(this._retryCount++,0<this._queue.length?(console.log("PlayablePipe._next",this._queue),this._pendingCallback=null,a(this._queue.shift())):(console.log("PlayablePipe._next empty queue"),this._pendingCallback=a),5>this._queue.length&&(console.log("PlayablePipe._next refill "+this._queue.length),this._refillQueue()))};
PlayablePipe.prototype._refillQueue=function(){console.log("PlayablePipe._refillQueue");var a=this;5<=this._array.length?(console.log("PlayablePipe._refillQueue add"),this._addToQueue()):this._newTracksCalled||(this._newTracksCalled=!0,this._newTracksCallback(function(c){console.log("[RADIO] Got new tracks.",c);a._array.push.apply(a._array,c);console.log("[RADIO] Got new tracks. added new tracks to array");a._newTracksCalled=!1;a._addToQueue()}))};
PlayablePipe.prototype._addToQueue=function(){console.log("[RADIO] fetching metadata ");for(var a=this,c=this._pendingCallback,f=this._array.splice(0,this._array.length),e=[],h=0;h<f.length;h++)e.push("spotify:track:"+f[h].trackId);console.log("[RADIO] fetching metadata for "+f.length+" tracks",f,e);sp.core.getMetadata(e,{onSuccess:function(e){console.log("track info available: ",e);for(var g=0;g<e.length;g++){var d=f[g],b=e[g];b&&b.availableForPlayback&&(d.trackName=b.name,b.album?(d.albumId=idFromUri(b.album.uri),
d.albumName=b.album.name,d.coverUri=b.album.cover):console.log("ALBUM ERROR",b),b.artists&&b.artists.length?(d.artistId=idFromUri(b.artists[0].uri),d.artistName=b.artists[0].name):console.log("ARTIST ERROR",b),d.availableForPlayback=b.availableForPlayback,d.starred=b.starred,a._queue.push(d))}c&&a._next(c)},onFailure:function(){console.log("track info failure: ");c&&a._next(c)}})};function idFromUri(a){return a.substring(a.lastIndexOf(":")+1)};
