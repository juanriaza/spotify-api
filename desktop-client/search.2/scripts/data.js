require(["$api/models","$api/search#Search","$api/hermes","scripts/config"],function(h,j,k,l){function g(a){this.logger=a;this.promises=[]}g.prototype.getUsers=function(a,b){var d=new h.Promise;this.startTimeout(d);var f=k.Schema.fromURL(["search.proto"]),c=this;k.Hermes.get("hm://search/search?bytesupport=false",[f.type("SearchReply")],[f.type("SearchRequest")]).send({query:a,type:["USER"],limit:b.amount,offset:b.start}).done(function(e){e=e[0];c.maxLengths[a].users=e.hits;if("undefined"!==typeof e.user){for(var b=
0,f=e.user.length;b<f;b+=1)e.user[b].uri="spotify:user:"+e.user[b].username;d.setDone(e.user)}else d.setDone();c.stopTimeout(d)}).fail(function(a){console.log("FAIL",a);d.setFail()});return d};g.prototype.getTopHitFromSuggest=function(a){var b=new h.Promise;this.suggestQuery=a;var d=this;2<a.length?(a=j.suggest(a),h.Promise.join(a.artists.snapshot(0,1),a.albums.snapshot(0,1),a.tracks.snapshot(0,1),a.playlists.snapshot(0,1)).done(function(a){d._onSuggestSnapshot(a,b)})):b.setFail();return b};g.prototype.dispose=
function(){this.search=null;this.maxLengths={}};g.prototype._onSuggestSnapshot=function(a,b){for(var d=[],f=0,c=a.length;f<c;f+=1)d.push(a[f].loadAll(["name","popularity"]));var e=this;h.Promise.join(d).always(function(a){e._onSuggestLoadDone(a,b)})};g.prototype._onSuggestLoadDone=function(a,b){for(var d=[],f,c,e,g=0,i=a.length;g<i;g+=1)c=a[g][0],"undefined"!==typeof c&&c.hasOwnProperty("popularity")&&(c instanceof h.Artist?e=1.2*c.popularity:c instanceof h.Album?e=1*c.popularity:c instanceof h.Track?
e=0.8*c.popularity:c instanceof h.Playlist&&(e=0.6*c.popularity),f=Math.abs(c.name.length-this.suggestQuery.length),e-=0.02*e*f,f={},f.name=c.name,f.popularity=e,d.push(f));0===d.length?b.setFail():(d.sort(function(a,b){return b.popularity-a.popularity}),d[0].name.toLowerCase()===this.suggestQuery.toLowerCase()?b.setFail():(b.object=d[0].name,b.setDone()))};g.prototype.loadSearch=function(a,b){var d=new h.Promise,f=+new Date;this._latestTime=d._latestTime=f;this.maxLengths[a]={};b=b||{};this.search=
j.search(a);this.startTimeout(d);var c=this;SpotifyApi.api.analyticsContext("loading search",function(){c.search.load(b.categories).done(function(a){c.onLoadDone(a,d)}).fail(function(a){c.onFail(a,d,"loadFail")})});return d};g.prototype.onLoadDone=function(a,b){b._latestTime===this._latestTime&&(b.object=a,this.stopTimeout(b),b.setDone())};g.prototype.onFail=function(a,b){b._latestTime===this._latestTime&&b.setFail()};g.prototype.getFuzzyMatch=function(){var a=new h.Promise,b=this;SpotifyApi.api.analyticsContext("load fuzzy match",
function(){b.search.load("fuzzyMatch").done(function(b){null===b.fuzzyMatch?a.setFail():(a.object=b.fuzzyMatch,a.setDone())}).fail(function(d){b.onFail(d,a,"fuzzy match not loaded")})});return a};g.prototype.getData=function(a,b,d){var f=new h.Promise,c=+new Date;this._latestTime=f._latestTime=c;this.startTimeout(f);for(var e=[],c=0,g=d.categories.length;c<g;c+=1)e[c]=a[d.categories[c]].snapshot(d.start,d.amount);var i=this;SpotifyApi.api.analyticsContext("snapshotting data",function(){h.Promise.join(e).done(function(a){i.onSnapshotDone(a,
b,d,f)}).fail(function(a){i.onFail(a,f,"dataFail")})});return f};g.prototype.onSnapshotDone=function(a,b,d,f){for(var c=[],e=0,g=a.length;e<g;e+=1)0<a[e].length&&a[e].range.length<=a[e].length&&(this.maxLengths[b][d.categories[e]]=a[e].length),c[e]=a[e].loadAll(l.PROPERTIES[d.categories[e]]);var i=this;SpotifyApi.api.analyticsContext("load data",function(){h.Promise.join(c).done(function(a){i.onSnapshotsLoaded(a,d,f)}).fail(function(a){i.onFail(a,null,"onSnapshotDoneFail")})})};g.prototype.onSnapshotsLoaded=
function(a,b,d){for(var f={},c=0,e=a.length;c<e;c+=1)a[c]&&0<a[c].length&&(f[b.categories[c]]=a[c]);this.onLoadDone(f,d)};g.prototype.startTimeout=function(a){clearTimeout(a.timeOut);var b=this;a.timeOut=setTimeout(function(){b.onFail(null,a,"promiseTimedOut")},l.TIMEOUT)};g.prototype.stopTimeout=function(a){clearTimeout(a.timeOut)};exports.Data=g});
