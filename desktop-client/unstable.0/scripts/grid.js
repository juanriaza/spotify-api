var sp=getSpotifyApi();exports.Grid=Grid;var storage=sp.require("$util/storage"),r=sp.require("$util/react");function Grid(a,b,c){this.identifier=a;this.datasource=b;this.node=c;this._generation=0;this._restored=!1;this._items={};_makeNode.call(this);_clear.call(this)}Grid.prototype.rebuild=function(){_clear.call(this);_build.call(this)};Grid.prototype.resize=function(){_build.call(this)};
function _makeNode(){this._grid=document.createElement("div");this._grid.classList.add("grid");this._grid.classList.add("vertical");this.node||(this.node=document.createElement("div"));this.node.classList.add("viewport");this.node.appendChild(this._grid);var a=this.node==document.body?document:this.node;r.throttle(r.fromDOMEvent(a,"scroll"),100).subscribe(_build.bind(this));r.throttle(r.fromDOMEvent(a,"scroll"),2E3).subscribe(_persist.bind(this))}
function _persist(){storage.set(this.identifier+"_scroll_position",[this.node.scrollLeft,this.node.scrollTop])}function _restore(){if(!this._restored){var a=storage.getWithDefault(this.identifier+"_scroll_position",[0,0]);this.node.scrollLeft=a[0];this.node.scrollTop=a[1];this._restored=!0}}function _clear(){this._generation=0;_pruneItems.call(this);this._offset_y=this._offset_x=this._row_last=this._col_last=this._row_first=this._col_first=-1}
function _build(){var a=this.datasource.padding,b=a?this.datasource.padding()[0]:0,c=a?this.datasource.padding()[1]:0,e=a?this.datasource.padding()[2]:0,j=a?this.datasource.padding()[3]:0,a=this.datasource.size()[0],k=this.datasource.size()[1],g=Math.min(this.node.clientWidth,this.node.offsetWidth)-j-c,h=Math.min(this.node.clientHeight,this.node.offsetHeight)-b-e;if(!(0>=g||0>=h)){var c=this.datasource.count(),l=Math.max(1,Math.min(c,Math.floor(this._grid.offsetWidth/a))),f=Math.ceil(c/l),e=f*k+b+
e+"px";if(this._grid.style.height!=e)this._grid.style.height=e,_build.call(this);else{_restore.call(this);var m=this.node.scrollLeft,d=this.node.scrollTop,e=Math.max(0,Math.floor(m/a)-10),i=Math.max(0,Math.floor(d/k)-10),g=Math.min(l-1,Math.ceil((m+g)/a+10)),h=Math.min(f-1,Math.ceil((d+h)/k+10));c>l&&(j+=Math.round(this._grid.offsetWidth-l*a)/2);f=j!=this._offset_x||b!=this._offset_y;if(e!=this._col_first||(i!=this._row_first||g!=this._col_last||h!=this._row_last)||f){this._generation++;this._col_first=
e;this._row_first=i;this._col_last=g;for(this._row_last=h;i<=h;i++)for(f=e;f<=g;f++)d=i*l+f,d<c&&(d=_makeItem.call(this,d),d.style.left=f*a+j+"px",d.style.top=i*k+b+"px",d.style.width=a+"px",d.style.height=k+"px",d._generation=this._generation);_pruneItems.call(this)}}}}function _makeItem(a){var b=this._items[a];b||(b=this.datasource.makeNode(a),b.style.position="absolute",this._grid.appendChild(b),this._items[a]=b);return b}
function _pruneItems(){var a=this;Object.keys(this._items).forEach(function(b){var c=a._items[b];c._generation!=a._generation&&(a._grid.removeChild(c),a.datasource.dropNode(c),delete a._items[b])})};
