require("$api/models $views/list/selection#ListSelection $views/utils/css $views/utils/dom $views/utils/dnd $views/scroll-agent#ScrollAgent $views/utils/range#Range $views/utils/html-string $api/library#Library $views/buttons".split(" "),function(q,B,h,l,y,C,z,w,D,E){function f(a){this.list=a;this.rows=[];this.selection=new B;this.selection.addList(a);this.numLoadedItems=0;this.createBase()}function x(a){var b=document.createElement("div");b.innerHTML=F[a];return b.children[0]}exports.ListView=f;
f.prototype.reset=function(){this.rows=[];this.numLoadedItems=0;this.nodes.tableBody.innerHTML="";this.setFixedHeight(!1)};f.prototype.init=function(){var a=this.list.options,b="fixed"===a.header,c=a.scrollElement||window;this.scrollElement="fixed"===a.height?b?this.nodes.body:this.node:c;this.realScrollElement=this.scrollElement===window?document.body:this.scrollElement;this.makeFocusable();this.makeSelectable();this.fixConnectedListsFocus();y.drag.hasDragSupport&&this.addDragListener();"function"===
typeof a.getItem&&(this.userGetItem=a.getItem);var d=this,b=function(){d.updateWidths()};this.list.eventHandlers.push({type:"resize",handler:b,obj:window,dom:!0});l.addEventListener(window,"resize",b);if("fixed"===a.header&&"dynamic"===a.height||"scroll"===a.fetch)a=function(a){d.onScroll(a)},this.list.eventHandlers.push({type:"scroll",handler:a,obj:this.scrollElement,dom:!0}),l.addEventListener(this.scrollElement,"scroll",a,!1);a=function(a){d.playerChange(a)};this.list.eventHandlers.push({type:"change",
handler:a,obj:q.player,dom:!1});q.player.addEventListener("change",a);if(-1<this.list.options.fields.indexOf("star")&&this.list.isTrackList&&!(-1<this.list.item.uri.indexOf(":starred"))){var e=D.forCurrentUser();e.load("starred").done(function(){var a=function(a){d.updateStarred(a.type,a.uris)};d.list.eventHandlers.push({type:"insert",handler:a,obj:e.starred,dom:!1});e.starred.addEventListener("insert",a);d.list.eventHandlers.push({type:"remove",handler:a,obj:e.starred,dom:!1});e.starred.addEventListener("remove",
a)})}};f.prototype.setupItemFetching=function(){var a=this;this.scrollAgent&&this.scrollAgent.destroy();this.getCollectionLength(function(b){var c=a.list.options.numItems,b=c?Math.min(c,b):b,c=a.scrollAgent=a.createScrollAgent(b),d=!1;c.addEventListener("request",function(b){a.onFetchRequest(b,!d);d||(d=!0)});c.addEventListener("show",function(){E.AddToCollectionButton.updateStates()});a.list.initialized&&a.startScrollAgent();0===b&&(a.list.dispatchEvent({type:"empty"}),a.list.dispatchEvent({type:"visually-empty"}),
a.list.dispatchEvent({type:"initial-snapshots"}),a.list.dispatchEvent({type:"initial-snapshots-load",snapshots:[{start:0,end:0,numItemsLoaded:0,numItems:0}]}),a.updateWidths())});this.list.addEventListener("initialized",function(){a.scrollAgent&&a.startScrollAgent()})};f.prototype.createScrollAgent=function(a){return new C(this.realScrollElement,{container:this.nodes.tableBody,prefill:!0,length:a,hotZone:1E3,deadZone:500,removeInvisibles:!0,tagName:"tr",height:this.getRowHeight(),limitDelta:200})};
f.prototype.getRowHeight=function(){if(this.rowHeight)return this.rowHeight;var a=document.createElement("tr");a.className="sp-list-item";this.nodes.tableBody.appendChild(a);this.rowHeight=a.offsetHeight;this.nodes.tableBody.removeChild(a);return this.rowHeight};f.prototype.getCollectionLength=function(a){var b=this.list.model;b.collection.snapshot(0,0).done(this,function(c){b.setupChangeListeners();a(c.length)})};f.prototype.onFetchRequest=function(a,b){this.list._dispatchEvent("scroll-fetch");var c=
this;this.list.model.snapshot(a.start,a.end-a.start,function(d,e){b&&c.list._dispatchEvent("initial-snapshots");c.createItems(d,e,function(d){b&&c.list._dispatchEvent({type:"initial-snapshots-load",snapshots:[c.list.model.snapshots[0]]});a.done(d)})})};f.prototype.onInsertRowsCreated=function(a,b,c){-1<this.list.options.fields.indexOf("ordinal")&&this.updateOrdinalsFrom(b);this.scrollAgent.insert(new z(a,b),c)};f.prototype.startScrollAgent=function(){var a=this.scrollAgent,b=this.list.options.fetch;
100<a.length&&("scroll"===b||"greedy"===b)?a.attach():a.show(new z(0,a.length))};f.prototype.addedToDOM=function(){this.updateWidths();this.setFixedHeight();this.setNodeHeightFromNumItems();this.setupItemFetching()};f.prototype.focus=function(){if(this.selection.focus.list===this.list.listIndex){var a=this.rows[this.selection.focus.item];if(a){var b=a.getBoundingClientRect().top;(0>b||b>window.innerHeight)&&a.scrollIntoView(0>b)}}this.node.focus()};f.prototype.blur=function(){this.node.blur()};f.prototype.setFixedHeight=
function(a){var b=this.list.options,c=!1===a?"removeClass":"addClass";if("no"!==b.header)h[c](this.node,"sp-list-using-header");if("fixed"===b.height||!1===a)h[c](this.node,"sp-list-fixed-height");if("fixed"===b.header||!1===a)h[c](this.node,"sp-list-wrapper-fixed-header");if("fixed"===b.height&&"fixed"===b.header||!1===a)h[c](this.nodes.headerWrapper,"sp-list-header-fixed-with-fixed-height")};f.prototype.setNodeHeightFromNumItems=function(){var a=this.list.options,b=a.numItems;if("fixed"!==a.height&&
0<b){a=this.list.model;0<a.snapshots.length&&(this.nodeHeightAdjusted=!0);b>a.totalLength&&(b=a.totalLength);var a=this.nodes.headerWrapper?this.nodes.headerWrapper.offsetHeight:0,c=parseInt(h.getStyle(this.nodes.wrapper,"border-top-width"),10)||0,d=parseInt(h.getStyle(this.nodes.wrapper,"border-bottom-width"),10)||0,c=this.nodes.wrapper?c+d:0,b=this.getRowHeight()*b;this.node.style.height=a+b+c+"px"}};f.prototype.createBase=function(){this.node=this.list.node||x("base");h.addClass(this.node,"sp-list-type-"+
this.list.type.toLowerCase());h.addClass(this.node,"sp-list-layout-"+this.list.layout.toLowerCase());this.createList();this.list.isDisc&&this.node.setAttribute("data-is-disc","true");var a=function(a){a.preventDefault()};this.list.eventHandlers.push({type:"selectstart",handler:a,obj:this.node,dom:!0});l.addEventListener(this.node,"selectstart",a)};f.prototype.createList=function(){var a=this.node,b=this.list.isPartOfDiscsList?x("discNumber"):null,c=x("list"),d=x("body");h.addClass(a,"sp-list-style-"+
this.list.options.style);if("no"!==this.list.options.header){var e=x("header");c.appendChild(e)}c.appendChild(d);b&&(b.innerHTML=this.list.discNumber,a.appendChild(b));a.appendChild(c);this.nodes={wrapper:c,body:d,tableBody:c.querySelector(".sp-list-table-body"),headerWrapper:c.querySelector(".sp-list-header"),headerContent:c.querySelector(".sp-list-header-table-wrapper"),headerRow:c.querySelector(".sp-list-header-row"),colgroups:{header:c.querySelector(".sp-list-header .sp-list-colgroup"),body:c.querySelector(".sp-list-body .sp-list-colgroup")}}};
f.prototype.addFields=function(){var a,b,c,d,e,g,j,f,i;a="no"!==this.list.options.header;b=this.list.model.fields;c=this.nodes.headerRow;d=this.nodes.colgroups;e=0;for(g=b.length;e<g;e++){if(a){j=document.createElement("th");j.className="sp-list-heading "+b[e].className;j.innerHTML=b[e].title||"&nbsp;";!i&&!b[e].fixedWidth&&(i=!0);if((!b[e].fixedWidth||b[e+1]&&!b[e+1].fixedWidth)&&i&&(b[0].fixedWidth&&0<e||!b[0].fixedWidth)&&(b[g-1].fixedWidth&&e<g-2||!b[g-1].fixedWidth))f=document.createElement("div"),
f.className="sp-list-heading-handle",f.colIndex=e,this.makeResizable(f),j.appendChild(f);c.appendChild(j);j=document.createElement("col");d.header.appendChild(j)}j=document.createElement("col");d.body.appendChild(j)}};f.prototype.updateWidths=function(){this.fullWidth=this.node.offsetWidth;this.list.dispatchEvent("resize");this.list.parentList&&this.list.parentList.dispatchEvent("resize");var a=this.list.options;"dynamic"===a.height&&("fixed"===a.header&&this.nodes.headerWrapper.fixed)&&(this.nodes.headerWrapper.style.width=
this.fullWidth+"px");"fixed"===a.height&&"fixed"===a.header&&(this.nodes.headerContent.style.width=(this.nodes.tableBody.offsetWidth||this.nodes.body.offsetWidth)+"px");var b,c,d,e,g,j;b="no"!==this.list.options.header;c="toplist"===this.list.layout;a=this.list.model.fields;d=this.nodes.colgroups;e=d.header&&d.header.children;g=d.body.children;d=c?this.nodes.tableBody.querySelectorAll(".sp-list-item"):void 0;if(c){var f=0;c=0;for(j=d.length;c<j;c++){b=d[c].children;e=f=0;for(g=b.length;e<g;e++)if(a[e].fixedWidth)f+=
a[e].fixedWidth;else if("track"===a[e].id){var i=parseInt(h.getStyle(b[e],"padding-right"),10);b[e].style.paddingLeft=f+i+"px"}else b[e].style.width=100*a[e].width+"%"}}else{c=0;for(j=a.length;c<j;c++)d=a[c].fixedWidth?a[c].width+"px":100*a[c].width+"%",g[c].style.width=d,b&&(e[c].style.width=d)}};f.prototype.removeItems=function(a,b){this.rows.splice(a,b-a);this.scrollAgent.remove(new z(a,b));0<this.list.options.numItems&&this.setNodeHeightFromNumItems();~this.list.options.fields.indexOf("ordinal")&&
this.updateOrdinalsFrom(a)};f.prototype.createItems=function(a,b,c){if(!this.list.destroyed)for(var d=this,e=this.list.model,g=0,j=b-a,f=Array(j),i=!1,h=a;h<b;h++)(function(h){var m=h-a;e.loadItem(h,function(e,h){h&&(i=!0);f[m]=e;if(++g===j)d.onItemsLoaded(a,b,f,i,c)})})(h)};f.prototype.onItemsLoaded=function(a,b,c,d,e){if(!this.list.destroyed){var g=this.list.model.items,j=w.createElement("tbody"),f=[];d&&this.updateWidths();if(this.userGetItem){c={rows:[]};for(d=a;d<b;d++)c.rows.push(this.userGetItem(g[d],
d))}else{for(d=a;d<b;d++)this.getItem(g[d],d,j,c[d-a],f);c=this.parseRowsHTML(j,a);0<f.length&&this.replaceTemporaryCells(f,c.rowContainer)}e(c.rows);"toplist"===this.list.layout&&this.setToplistCellOffsetForRows(c.rows)}};f.prototype.parseRowsHTML=function(a,b){var c=document.createElement("div");c.innerHTML="<table>"+a.children.join("")+"</table>";var d=Array.prototype.slice.call(c.firstChild.firstChild.children);this.rows.length<b&&(this.rows[b-1]=void 0);void 0!==this.rows[b]?this.rows.splice.apply(this.rows,
[b,0].concat(d)):this.rows.splice.apply(this.rows,[b,d.length].concat(d));return{rows:d,rowContainer:c}};f.prototype.replaceTemporaryCells=function(a,b){for(var c=0,d=a.length;c<d;c++){var e=a[c],g=b.querySelector(["#",e.id].join(""));g.parentNode.replaceChild(e.content,g)}};f.prototype.setToplistCellOffsetForRows=function(a){var b=this.list.options.fields,c=b.indexOf("track"),b=b.indexOf("album");if(-1<c||-1<b)for(var d=0,e=a.length;d<e;d++){var g=a[d],j=g.children,f=j[c],j=j[b];(f||j)&&this.setToplistCellOffset(f,
j,g,this.totalFixedWidth)}};f.prototype.getItem=function(a,b,c,d,e){if(!this.list.destroyed){this.numLoadedItems++;var g=this.createRowTag(a),j=this.list.model,a=j.items[b],j=j.itemData[b];d.error?this.handleItemLoadError(a,b,g,j,d,e):this.handleItemLoadSuccess(a,b,g,j,d,e);c.appendChild(g)}};f.prototype.createRowTag=function(a){var b=w.createElement("tr");y.drag.hasDragSupport&&b.setAttribute("draggable","true");b.setAttribute("data-uri",a.uri);b.addClass("sp-list-item");return b};f.prototype.handleItemLoadError=
function(a,b,c,d){var e=this.list,g=e.model,j=g.items,f=g.snapshots[d.snapshotIndex];f.numItemsLoaded++;d.hidden=!0;c.addClass("sp-list-item-hidden");this.numLoadedItems===g.totalLength&&!this.hasFoundPlayableTrack&&e.dispatchEvent({type:"visually-empty"});e._dispatchEvent({type:"item-load-fail",index:b,item:a});f.numItemsLoaded===f.numItems&&e._dispatchEvent({type:"snapshot-load",index:d.snapshotIndex,items:j.slice(f.start,f.end)})};f.prototype.handleItemLoadSuccess=function(a,b,c,d,e,g){var f=this,
h=this.list,i=h.model,u=i.items,k=i.snapshots[d.snapshotIndex];k.numItemsLoaded++;var m=h.options;e.imageOptions=m.imageOptions;h.isTrackList&&"hidden"===m.unplayable&&(e.track.playable&&(this.hasFoundPlayableTrack=!0),this.numLoadedItems===i.totalLength&&!this.hasFoundPlayableTrack&&h.dispatchEvent({type:"visually-empty"}));h.isTrackList&&(this.updatePlayability(a,d,c,e.track.playable),e.track.playable||(d.playableChangeHandler=function(){f.updatePlayability(a,d,c,a.playable)},a.addEventListener("change:playable",
d.playableChangeHandler),this.list.eventHandlers.push({type:"change:playable",handler:d.playableChangeHandler,obj:a,dom:!1})));this.createRowFromData(e,c,g);d.loaded=!0;h._dispatchEvent({type:"item-load",index:b,item:a});k.numItemsLoaded===k.numItems&&h._dispatchEvent({type:"snapshot-load",index:d.snapshotIndex,items:u.slice(k.start,k.end)});"fixed"===m.height&&"fixed"===m.header&&(this.nodes.headerContent.style.width=(this.nodes.tableBody.offsetWidth||this.nodes.body.offsetWidth)+"px")};f.prototype.updatePlayability=
function(a,b,c,d){this.list.isTrackList&&!d?(c.addClass("sp-list-item-unplayable"),"hidden"===this.list.options.unplayable&&(c.addClass("sp-list-item-hidden"),b.hidden=!0)):(c.removeClass("sp-list-item-unplayable"),c.removeClass("sp-list-item-hidden"),b.hidden=!1)};f.prototype.createRowFromData=function(a,b,c){var d=this.list.model.fields,e=this.list.options.fields,g,f,h="toplist"===this.list.layout,i=this.list.isTrackList,u=this.list.isAlbumItem,k,m,r,p,s=0,n,l;r=(a.artists?this.list._getArtistsURIString(a.artists):
"")!==this.list.albumArtists;p=a.track?a.track.explicit:!1;for(var t=0,q=d.length;t<q;t++){g=d[t];f=d[t-1];n=void 0;k="trackartist"===e[t];m="track"===e[t];if(i&&!h&&u&&k){f=this.handleTrackArtistField(r,v,f,g);if(f.shouldAbortIteration)continue;l=f.contextButton;n=f.content}var v=this.createCellTag(g.className,k);n=void 0===n?d[t].get(a):n;k&&(r&&l)&&(n=this.handleContextButtonInTrackArtist(v,l,n));this.addCellContent(v,n,c);p&&(m&&n instanceof Array&&(l=v.children[0]),this.addExplicitIconToCell(v,
h,m,k,r,l));g.fixedWidth?this.totalFixedWidth||(s+=d[t].fixedWidth):(!h||h&&!~"track album".indexOf(g.id))&&v.setAttribute("style",["width: ",100*d[t].width,"%"].join(""));b.appendChild(v)}this.totalFixedWidth||(this.totalFixedWidth=s)};f.prototype.createCellTag=function(a,b){var c=w.createElement("td");c.addClass("sp-list-cell");c.addClass(a);b&&c.addClass("sp-list-cell-trackartist");return c};f.prototype.handleTrackArtistField=function(a,b,c,d){var e,g,f=!1;a?b&&b.hasClass("sp-list-cell-track")&&
(g=b.children[0],-1<g.toString().indexOf("sp-quickactionbuttons")?b.removeChild(g):g=null):c&&void 0===c.fixedWidth?(b.setAttribute("style",["width: ",100*c.width+100*d.width,"%"].join("")),b.setAttribute("colspan","2"),f=!0):e="";return{content:e,contextButton:g,shouldAbortIteration:f}};f.prototype.handleContextButtonInTrackArtist=function(a,b,c){a.appendChild(b);a=w.createElement("span").addClass("sp-list-cell-artist-names");a.appendChild(c);return c=a.toString()};f.prototype.createTemporaryCellElement=
function(a,b){var c=["tempelem-",Math.round(1E6*Math.random())].join(""),d=w.createElement("span");d.setAttribute("id",c);b.push({id:c,content:a});return d};f.prototype.addCellContent=function(a,b,c){if("string"===typeof b)a.appendChild(b);else if(b instanceof Array)for(var d=0,e=b.length;d<e;d++)this.addCellContent(a,b[d],c);else a.appendChild(this.createTemporaryCellElement(b,c))};f.prototype.addExplicitIconToCell=function(a,b,c,d,e,g){if(c&&b||c&&!e||d&&e)b=w.createElement("span"),b.addClass("sp-icon-explicit"),
g?a.insertBefore(b,a.children[a.children.indexOf(g)+1]):a.insertBefore(b,a.children[0])};f.prototype.setToplistCellOffset=function(a,b,c,d){var e=h.getStyle(a||b,"padding-right");if(""===e){var g=this,f=a||b;f.numOffsetTries=(f.numOffsetTries||0)+1;if(10<=f.numOffsetTries)delete f.numOffsetTries;else{setTimeout(function(){g.setToplistCellOffset(a,b,c,d)},50);return}}e=parseInt(e||0,10);d+=e;a&&b?(e=document.createElement("div"),e.className="sp-list-cell sp-list-cell-trackalbum-wrapper",c.replaceChild(e,
b),c.removeChild(a),e.appendChild(a),e.appendChild(b),e.style.paddingLeft=d+"px"):a?a.style.paddingLeft=d+"px":b&&(b.style.paddingLeft=d+"px")};f.prototype.makeResizable=function(a){var b=this,c=function(c){b.handleDragStart(a,c)},d=function(c){b.handleDragMove(a,c)},e=function(c){b.handleDragEnd(a,c)};this.list.eventHandlers.push({type:"mousedown",handler:c,obj:a,dom:!0});this.list.eventHandlers.push({type:"mousemove",handler:d,obj:document,dom:!0});this.list.eventHandlers.push({type:"mouseup",handler:e,
obj:document,dom:!0});l.addEventListener(a,"mousedown",c);l.addEventListener(document,"mousemove",d,!0);l.addEventListener(document,"mouseup",e,!0)};f.prototype.handleDragStart=function(a,b){for(var c=this.list.model.fields,d=a.colIndex;c[d]&&c[d].fixedWidth;)d--;for(var e=a.colIndex+1;c[e]&&c[e].fixedWidth;)e++;c[d]&&c[e]&&(this.currentHandle=a,a.isDragging=!0,a.startPos=b.pageX||b.clientX,a.leftIndex=d,a.rightIndex=e,a.startLeftWidth=c[d].dynamicWidth,a.startRightWidth=c[e].dynamicWidth)};f.prototype.handleDragMove=
function(a,b){if(a.isDragging&&a===this.currentHandle){var c=(b.pageX||b.clientX)-a.startPos,d=this.list.model.fields,e=a.startLeftWidth*d.totalDynamicWidth+c,c=a.startRightWidth*d.totalDynamicWidth-c;50<e&&50<c&&(d[a.leftIndex].dynamicWidth=e/d.totalDynamicWidth,d[a.rightIndex].dynamicWidth=c/d.totalDynamicWidth,this.updateWidths())}};f.prototype.handleDragEnd=function(a){if(a===this.currentHandle){a.isDragging=!1;this.currentHandle=null;var b=this.list.model.fields,a={type:"column-resize",left:{index:a.leftIndex,
startWidth:a.startLeftWidth,endWidth:b[a.leftIndex].dynamicWidth},right:{index:a.rightIndex,startWidth:a.startRightWidth,endWidth:b[a.rightIndex].dynamicWidth}};this.list.dispatchEvent(a);this.list.parentList&&this.list.parentList.dispatchEvent(a)}};f.prototype.onScroll=function(){var a=this.list.options,b=this.nodes.headerWrapper,c=this.scrollElement,d=this.node.getBoundingClientRect();if("fixed"===a.header&&"dynamic"===a.height){var a=b.offsetHeight,e=b.getBoundingClientRect().top,g=0;c!==window&&
(g=parseFloat(h.getStyle(c,"border-top-width"),10),g=isNaN(g)?0:g,g=c.getBoundingClientRect().top+g);if(!b.fixed&&e<=g&&d.bottom>g+a)h.addClass(b,"sp-list-header-fixed"),h.addClass(this.node,"sp-list-wrapper-header-fixed"),b.style.width=(this.nodes.tableBody.offsetWidth||this.nodes.body.offsetWidth)+"px",b.style.top=g+"px",b.fixed=!0;else if(b.fixed&&(e>g||d.top>g||d.bottom<g+a))h.removeClass(b,"sp-list-header-fixed"),h.removeClass(this.node,"sp-list-wrapper-header-fixed"),b.style.width="100%",b.style.top=
"auto",b.fixed=!1}};f.prototype.selectItem=function(a){var b=this.list.model.getListChain();if(1<b.length)for(var c=0,d=b.length;c<d;c++)b[c].view.dontBlur=!0;b=this.rows[a];h.addClass(b,"sp-list-item-selected");this.list.dispatchEvent({type:"item-select",index:a,item:this.list.model.items[a],row:b});this.list.parentList&&this.list.parentList.dispatchEvent({type:"item-select",index:a,item:this.list.model.items[a],row:b})};f.prototype.deselectItem=function(a){var b=this.rows[a];h.removeClass(b,"sp-list-item-selected");
this.list.dispatchEvent({type:"item-deselect",index:a,item:this.list.model.items[a],row:b});this.list.parentList&&this.list.parentList.dispatchEvent({type:"item-deselect",index:a,item:this.list.model.items[a],row:b})};f.prototype.deselect=function(){for(var a=this.selection.getSelectionForList(this.list.listIndex),b=0,c=a.length;b<c;b++)this.deselectItem(a[b])};f.prototype.makeFocusable=function(){this.dontBlur=!1;var a=this,b=this.node,c=void 0!==window.onfocusin,d=c?"focusin":"focus",c=c?"focusout":
"blur";b.tabIndex=0;var e=function(){h.addClass(this,"sp-list-wrapper-focus")};this.list.eventHandlers.push({type:d,handler:e,obj:b,dom:!0});l.addEventListener(b,d,e,!1);d=function(){a.dontBlur||h.removeClass(this,"sp-list-wrapper-focus")};this.list.eventHandlers.push({type:c,handler:d,obj:b,dom:!0});l.addEventListener(b,c,d,!1);"no"!==this.list.options.header&&(d=function(){a.dontBlurHeader=!0},this.list.eventHandlers.push({type:"mousedown",handler:d,obj:this.nodes.headerWrapper,dom:!0}),l.addEventListener(this.nodes.headerWrapper,
"mousedown",d,!1),d=function(){a.dontBlurHeader&&b.focus();a.dontBlurHeader=!1},this.list.eventHandlers.push({type:"mouseup",handler:d,obj:document,dom:!0}),l.addEventListener(document,"mouseup",d,!1))};f.prototype.isElementInAnyListView=function(a){for(;a!==document&&!h.hasClass(a,"sp-list");)a=a.parentNode;return a!==document?!0:!1};f.prototype.isElementInAnyConnectedListView=function(a){for(;a!==document&&!h.hasClass(a,"sp-list");)a=a.parentNode;for(var b=this.list.model.getListChain(),c=0,d=b.length;c<
d;c++)b[c]=b[c].node;return a!==document?!!~b.indexOf(a):!1};f.prototype.getListNodeFromElement=function(a){for(var b=document.body;a!==b&&(!h.hasClass(a,"sp-list")||a.getAttribute("data-is-disc"));)a=a.parentNode;return a===b?null:a};f.prototype.fixConnectedListsFocus=function(){var a=this,b=!1,c=this.list,d=this.list.model;f.listViewConnectedContainerArray||(f.listViewConnectedContainerArray=[]);this.list.parentList&&(b=!0,c=this.list.parentList,d=c.lists[0].model);var e=c._connectedListsIndex;
if(void 0===e)for(var g=d.getListChain(),d=0,j=g.length;d<j;d++)if(void 0!==g[d]._connectedListsIndex){e=g[d]._connectedListsIndex;break}g=!1;if(b)for(var A=f.listViewConnectedContainerArray,i,d=0,j=A.length;d<j;d++){i=A[d];for(var u=0,k=i.length;u<k;u++)i[u]===c&&(g=!0)}if(void 0===e&&!g)e=f.listViewConnectedContainerArray.push([c])-1,c._connectedListsIndex=e,c.node.setAttribute("data-connected-lists-index",e),f.listViewDocMouseDownHandler||(f.listViewDocMouseDownHandler=function(b){for(var c=[],
d=[],e=[],c=f.listViewConnectedContainerArray,g=0,j=c.length;g<j;g++)e=e.concat(c[g]);if(a.isElementInAnyListView(b.target)){g=a.getListNodeFromElement(b.target).getAttribute("data-connected-lists-index");c=f.listViewConnectedContainerArray[g];g=0;for(j=c.length;g<j;g++)for(var b=c[g],b=b.isDiscsList?b.lists:[b],i=0,k=b.length;i<k;i++)h.addClass(b[i].view.node,"sp-list-wrapper-focus");g=0;for(j=e.length;g<j;g++)-1===c.indexOf(e[g])&&d.push(e[g])}else d=e;g=0;for(j=d.length;g<j;g++){b=d[g];b=b.isDiscsList?
b.lists:[b];i=0;for(k=b.length;i<k;i++)b[i].view.dontBlur=!1,h.removeClass(b[i].view.node,"sp-list-wrapper-focus")}},l.addEventListener(document,"mousedown",f.listViewDocMouseDownHandler));else if(!b||!g)f.listViewConnectedContainerArray[e].push(c),c._connectedListsIndex=e,c.node.setAttribute("data-connected-lists-index",e)};f.prototype.addDragListener=function(){var a=this;if(!this.selection.isDndAdded){this.selection.isDndAdded=!0;var b,c=function(c){return!(c instanceof HTMLAnchorElement)&&a.isElementInAnyConnectedListView(c)?
(b=a.selection.getSelectionData(),0<b.uris.length):!1},d=function(){var c=b.urls.join("\n"),d=b.urls.map(function(c,d){var e=b.items[d];if(e instanceof q.Track)var g=a.getArtistsAsString(e.artists),e=e.name+" by "+g;else e=c;return'<a href="'+c+'">'+e+"</a>"}).join("<br>\n");return{"text/plain":c,"text/html":d}},e=function(){var c=b.uris.length,d=a.list.isTrackList;return 1===c&&d?(c=b.items[0],d=a.getArtistsAsString(c.artists),c.name+" by "+d):c+" "+(d?"tracks":"items")};y.drag.addHandler(c,d,e);
this.dndTestFunc=c;this.dndGetDataFunc=d;this.dndGetTextFunc=e}};f.prototype.removeDndHandlers=function(){this.dndTestFunc&&(this.dndGetDataFunc&&this.dndGetTextFunc)&&y.drag.removeHandler(this.dndTestFunc,this.dndGetDataFunc,this.dndGetTextFunc)};f.prototype.getArtistsAsString=function(a){for(var b="",c=0,d=a.length;c<d;c++)b+=a[c].name+(c<d-1?", ":"");return b};f.prototype.makeSelectable=function(){var a=this;"desktop"===this.list.model.userDevice&&(this.nodes.tableBody.oncontextmenu=function(b){if("a"===
b.target.tagName.toLowerCase()){var d=b.target.getAttribute("data-uri");if(d){var e=q.fromURI(d);if(e)return d=b.pageX-window.pageXOffset,b=b.pageY-window.pageYOffset,q.client.showContextUI(e,{x:d,y:b}),!1}}else if(e=a.selection.getSelectionData(),0<e.items.length){var g=e.fromSameList?a.list.item:void 0,d=b.pageX-window.pageXOffset,b=b.pageY-window.pageYOffset;q.client.showContextUI(e.items,{x:d,y:b},g);return!1}});var b=function(b){a.listMouseDown(b,this)};this.list.eventHandlers.push({type:"mousedown",
handler:b,obj:this.nodes.tableBody,dom:!0});l.addEventListener(this.nodes.tableBody,"mousedown",b);b=function(b){a.listKeyDown(b,this)};this.list.eventHandlers.push({type:"keydown",handler:b,obj:this.node,dom:!0});l.addEventListener(this.node,"keydown",b,!0);this.list.isTrackList&&(b=function(b){a.listDblClick(b,this)},this.list.eventHandlers.push({type:"dblclick",handler:b,obj:this.nodes.tableBody,dom:!0}),l.addEventListener(this.nodes.tableBody,"dblclick",b));b=function(b){a.listClick(b,this)};
this.list.eventHandlers.push({type:"click",handler:b,obj:this.nodes.tableBody,dom:!0});l.addEventListener(this.nodes.tableBody,"click",b)};f.prototype.listMouseDown=function(a){if(!h.hasClass(a.target,"sp-icon-star")&&!h.hasClass(a.target,"sp-icon-star-hitarea")&&(!h.hasClass(a.target,"sp-list-sharebutton")&&!h.hasClass(a.target,"sp-list-share-hitarea")&&"a"!==a.target.tagName.toLowerCase())&&(!(~this.list.options.fields.indexOf("track")&&"web"===this.list.model.userDevice)||!h.hasClass(a.target,
"sp-quickactionbuttons"))){var b=this.getListRowNode(a.target);b&&this.handleMouseSelection(b,a)}};f.prototype.handleMouseSelection=function(a,b,c){a=this.rows.indexOf(a);if(!c||!this.changedSelectionOnMouseDown)if(this.changedSelectionOnMouseDown=!1,~a){var d={"0":1,2:2,1:3,"default":0},d=d[b.button]||d["default"],e=1===d,g=2===d,d=this.list.listIndex,f=this.selection,h=-1<navigator.userAgent.indexOf("Mac")?b.metaKey:b.ctrlKey,h=b.shiftKey||h,b=!b.shiftKey,i=f.isSelected(a,d);if(h&&b&&i&&e)c=f.focus.item,
b=f.focus.list,e=f.origin,g=c>e.item,e=a+((b===e.list?!g:!(b>e.list))?-1:1),e=-1<f.indices[d].indexOf(e)?e:!1,this.changedSelectionOnMouseDown=!0,f.remove(a,d),!1!==e&&f.setOrigin(e,d),f.setFocus(c,b);else if(b){if((!g||!i)&&(!e||!i||c))h||f.clear(),f.add(a,d),f.setOrigin(a,d),this.changedSelectionOnMouseDown=!0}else f.isInCurrentGroup(a,d)?f.removeTo(a+(f.isDirectionDown?1:-1),d):f.addTo(a,d),this.changedSelectionOnMouseDown=!0}};f.prototype.listKeyDown=function(a){var b=38===a.keyCode,c=40===a.keyCode;
13===a.keyCode&&(this.selection.hasSelection(this.list.listIndex)&&this.list.isTrackList)&&(a.preventDefault(),a.stopPropagation(),this.list.playTrack(this.selection.getIndex(0,this.list.listIndex),this.list.discNumber-1));(b||c)&&(!a.metaKey&&!a.ctrlKey)&&this.moveSelection(c,a)};f.prototype.listDblClick=function(a){!h.hasClass(a.target,"sp-icon-star")&&!h.hasClass(a.target,"sp-icon-star-hitarea")&&(a=a.target.tagName.toLowerCase(),"a"!==a&&"button"!==a&&this.list.playTrack(this.selection.getIndex(0,
this.list.listIndex),this.list.discNumber-1))};f.prototype.listClick=function(a){var b=a.target,c=b.getAttribute("data-uri"),d=!!c&&0===c.indexOf("spotify:"),e=b.getAttribute("data-button"),e=!!e&&"share"===e,g=h.hasClass(a.target,"sp-icon-star")||h.hasClass(a.target,"sp-icon-star-hitarea");if(d)a.preventDefault(),a.stopPropagation(),this.list.dispatchEvent({type:"list-click",uri:c}),this.list.parentList&&this.list.parentList.dispatchEvent({type:"list-click",uri:c}),q.application.openURI(c);else if(e)this.openShareUI(b);
else if(g){if(b=this.getListRowNode(a.target)){var f=b.querySelector(".sp-icon-star"),l=!!b.querySelector(".sp-icon-starred"),c=b.getAttribute("data-uri"),i=q.Track.fromURI(c);h[l?"removeClass":"addClass"](f,"sp-icon-starred");i.load("starred").done(function(){i.starred===l&&i[i.starred?"unstar":"star"]().fail(function(){h[l?"addClass":"removeClass"](f,"sp-icon-starred")})})}}else(b=this.getListRowNode(a.target))&&this.handleMouseSelection(b,a,!0)};f.prototype.openShareUI=function(a){var b=this.getListRowNode(a);
b&&(b=b.getAttribute("data-uri"),a=a.getBoundingClientRect(),q.client.showShareUI(b,"",{x:a.left+a.width/2,y:a.top+a.height/2}))};f.prototype.getListRowNode=function(a){for(var b=this.nodes.tableBody;a!==b&&!h.hasClass(a,"sp-list-item");)a=a.parentNode;return a===b?null:a};f.prototype.moveSelection=function(a,b){if(this.selection.focus.list===this.list.listIndex){var c=this.list.model.items,d=this.list.model.itemData,e=this.selection.focus.item,f=e+(a?1:-1),h=c[f],l=d[f],i=!a&&0===e,q=a&&e===c.length-
1,k=this.selection,m=k.isDirectionDown,r=k.isDirectionUp,p=this.list.listIndex,s=k.origin.list,n=k.origin.item;if(i||q){for(c=i?this.list.previousList:this.list.nextList;;){if(c&&c.lists){c=i?c.lists[c.lists.length-1]:c.lists[0];break}if(this.list.isPartOfDiscsList&&!c&&(c=i?this.list.parentList.previousList:this.list.parentList.nextList))continue;break}if(c){b&&b.preventDefault();i=i?c.model.items.length-1:0;d=c.listIndex;h=c.view.selection;if(!b||!b.shiftKey||!k.multiselectEnabled)h.clear(),h.setOrigin(i,
c.listIndex),n=i,s=c.listIndex,m=r=!1;m=m&&a||r&&!a||!m&&!r;!h.isSelected(i,d)&&m?(h.add(i,d),b&&b.shiftKey?(h.isDirectionDown=p>s?!0:p<s?!1:f>n?!0:!1,h.isDirectionUp=p<s?!0:p>s?!1:f<n?!0:!1):(h.isDirectionDown=!1,h.isDirectionUp=!1)):m?h.setFocus(i,d):k.remove(e,p);c.focus()}}else{for(;f<c.length-1&&-1<f&&!h||l&&!l.loaded||l&&l.hidden;)f+=a?1:-1,h=c[f],l=d[f];if(h){b&&(b.preventDefault(),b.stopPropagation());if(!b||!b.shiftKey||!k.multiselectEnabled)k.clear(),k.setOrigin(f,p),n=f,s=p,m=r=!1;m=m&&
a||r&&!a||!m&&!r;!k.isSelected(f,p)&&m?(k.add(f,p),b&&b.shiftKey?(k.isDirectionDown=p>s?!0:p<s?!1:f>n?!0:!1,k.isDirectionUp=p<s?!0:p>s?!1:f<n?!0:!1):(k.isDirectionDown=!1,k.isDirectionUp=!1)):m?k.setFocus(e+(a?1:-1),p):k.isSelected(e,p)?k.remove(e,p):k.setFocus(e+(a?1:-1),p);e=this.scrollElement;k=e===window;n=this.rows[f].getBoundingClientRect();m=(f=this.nodes.headerWrapper)&&f.getBoundingClientRect().bottom;r=k?0:this.node.getBoundingClientRect().top;p="fixed"===this.list.options.header;s="dynamic"===
this.list.options.height;i=p?m:r;c=k?window.innerHeight:e.getBoundingClientRect().bottom;if(n.top<i||n.bottom>c)m=e.pageXOffset||(e===window?document.documentElement.scrollLeft:e.scrollLeft),r=e.pageYOffset||(e===window?document.documentElement.scrollTop:e.scrollTop),n=e===window?a?n.bottom-window.innerHeight:n.top:a?n.bottom-c:n.top-i,f=!a&&p&&s&&k?f.offsetHeight:0,e.scrollTo?e.scrollTo(m,r+n-f):e.scrollTop=r+n-f}}}};f.prototype.playerChange=function(){function a(){if(!b.list.destroyed){var a=!(!e.context||
!(c.context&&e.context.uri===c.context.uri)),f=d?b.list.isDisc?b.list.discNumber===d.disc:!0:!1;if(a&&b.isPlaying&&b.list.model.contextHasUpdates&&b.list.model.items[b.playingIndex+1])b.list.model.contextHasUpdates=!1,b.list.playTrack(b.playingIndex+1,b.list.discNumber-1);else{if(!a||!d||!f)return b.setPlayingState(!1);a=b.list.isDisc?d.number-1:c.index;e.items[a]?b.setPlayingState(a,c.playing):b.setPlayingState(!1)}}}if(!this.list.destroyed){var b=this,c=q.player,d=c.track,e=this.list.model;this.list.isDisc&&
d?d.load("disc","number").done(function(){a()}):a()}};f.prototype.setPlayingState=function(a,b){if(!1!==a&&!this.rows[a]){var c=this;setTimeout(function(){c.setPlayingState(a,b)},50)}else if(!this.playingRow||!(this.playingIndex===a&&b===this.playingRow.playing))if(this.playingRow&&(h.removeClass(this.playingRow,"sp-list-item-playing"),h.removeClass(this.playingRow,"sp-list-item-paused"),this.isPlaying=!1,this.playingIndex=this.playingRow=null),!1!==a){var d=this.rows[a];h.addClass(d,b?"sp-list-item-playing":
"sp-list-item-paused");this.playingRow=d;this.playingRow.playing=b;this.isPlaying=!0;this.playingIndex=a}};f.prototype.updateStarred=function(a,b){for(var c=this.list.model.uris,d=this.rows,e="insert"===a,f,j,l=0,i=b.length;l<i;l++)if(f=c.indexOf(b[l]),-1<f&&(f=d[f]))if(f=f.querySelector(".sp-icon-star"),j=h.hasClass(f,"sp-icon-starred"),j!==e)h[e?"addClass":"removeClass"](f,"sp-icon-starred")};f.prototype.updateOrdinalsFrom=function(a){var b=this.list.options.fields.indexOf("ordinal");if(~b)for(var c=
this.list,d=this.rows,e=c.model.items,f=c.model.itemData,h=c.model.fields,l="hidden"===c.options.unplayable,i=this.rows.length;a<i;a++)if(f[a]&&(!f[a].hidden||!l||e[a].playable)){var q=d[a]&&d[a].children[b];q&&h[b].update({index:a,list:c},q)}};var F={base:'<div class="sp-list"></div>',header:'<div class="sp-list-header">\n  <div class="sp-list-header-table-wrapper">\n    <table class="sp-list-header-table">\n      <colgroup class="sp-list-colgroup"></colgroup>\n      <tbody>\n        <tr class="sp-list-header-row"></tr>\n      </tbody>\n    </table>\n  </div>\n</div>',
body:'<div class="sp-list-body">\n  <table class="sp-list-table">\n    <colgroup class="sp-list-colgroup">\n    </colgroup>\n    <tbody class="sp-list-table-body">\n    </tbody>\n  </table>\n</div>',list:'<div class="sp-list-wrapper"></div>',discNumber:'<span class="sp-list-disc-number"></span>'}});
