require("$api/models $views/list/selection#ListSelection $views/utils/css $views/utils/dom $views/utils/dnd $views/contextapp#ContextApp $api/library#Library".split(" "),function(s,y,i,k,v,z,A){function f(a){this.list=a;this.rows=[];this.selection=new y;this.selection.addList(a);this.popupShown=!1;this.numLoadedItems=0;this.shownIndices=[];this.createBase()}function t(a){var b=document.createElement("div");b.innerHTML=B[a];return b.children[0]}exports.ListView=f;f.prototype.reset=function(){this.rows=
[];this.numLoadedItems=0;this.nodes.tableBody.innerHTML="";this.setFixedHeight(!1);this.getNumItemsPerBucket()};f.prototype.init=function(){var a=this.list.options,b="fixed"===a.header,c=a.scrollElement||window;this.scrollElement="fixed"===a.height?b?this.nodes.body:this.node:c;this.makeFocusable();this.makeSelectable();this.fixWidgetButtonVisibility();this.fixConnectedListsFocus();v.drag.hasDragSupport&&this.addDragListener();"function"===typeof a.getItem&&(this.getItem=a.getItem);var d=this,b=function(){d.updateWidths();
d.checkResizeEdge()};this.list.eventHandlers.push({type:"resize",handler:b,obj:window,dom:!0});k.addEventListener(window,"resize",b);if("fixed"===a.header&&"dynamic"===a.height||"scroll"===a.fetch)a=function(a){d.onScroll(a)},this.list.eventHandlers.push({type:"scroll",handler:a,obj:this.scrollElement,dom:!0}),k.addEventListener(this.scrollElement,"scroll",a,!1);a=function(a){d.playerChange(a)};this.list.eventHandlers.push({type:"change",handler:a,obj:s.player,dom:!1});s.player.addEventListener("change",
a);if(-1<this.list.options.fields.indexOf("star")&&this.list.isTrackList&&!(-1<this.list.item.uri.indexOf(":starred"))){var e=A.forCurrentUser();e.load("starred").done(function(){var a=function(a){d.updateStarred(a.type,a.uris)};d.list.eventHandlers.push({type:"insert",handler:a,obj:e.starred,dom:!1});e.starred.addEventListener("insert",a);d.list.eventHandlers.push({type:"remove",handler:a,obj:e.starred,dom:!1});e.starred.addEventListener("remove",a)})}};f.prototype.addedToDOM=function(){this.updateWidths();
this.getNumItemsPerBucket();this.setFixedHeight();this.setNodeHeightFromNumItems()};f.prototype.focus=function(){if(this.selection.focus.list===this.list.listIndex){var a=this.rows[this.selection.focus.item];if(a){var b=a.getBoundingClientRect().top;(0>b||b>window.innerHeight)&&a.scrollIntoView(0>b)}}this.node.focus()};f.prototype.blur=function(){this.node.blur()};f.prototype.setFixedHeight=function(a){var b=this.list.options,c=!1===a?"removeClass":"addClass";if("no"!==b.header)i[c](this.node,"sp-list-using-header");
if("fixed"===b.height||!1===a)i[c](this.node,"sp-list-fixed-height");if("fixed"===b.header||!1===a)i[c](this.node,"sp-list-wrapper-fixed-header");if("fixed"===b.height&&"fixed"===b.header||!1===a)i[c](this.nodes.headerWrapper,"sp-list-header-fixed-with-fixed-height")};f.prototype.setNodeHeightFromNumItems=function(){var a=this.list.options,b=a.numItems;if("fixed"!==a.height&&0<b){a=this.list.model;0<a.snapshots.length&&(this.nodeHeightAdjusted=!0,b>a.totalLength&&(b=a.totalLength));var a=this.nodes.headerWrapper?
this.nodes.headerWrapper.offsetHeight:0,c=parseInt(i.getStyle(this.nodes.wrapper,"border-top-width"),10)||0,d=parseInt(i.getStyle(this.nodes.wrapper,"border-bottom-width"),10)||0;this.node.style.height=a+this.itemHeight*b+(this.nodes.wrapper?c+d:0)+"px"}};f.prototype.createBase=function(){this.node=this.list.node||t("base");i.addClass(this.node,"sp-list-type-"+this.list.type.toLowerCase());i.addClass(this.node,"sp-list-layout-"+this.list.layout.toLowerCase());this.createList();this.list.isDisc&&this.node.setAttribute("data-is-disc",
"true");var a=function(a){a.preventDefault()};this.list.eventHandlers.push({type:"selectstart",handler:a,obj:this.node,dom:!0});k.addEventListener(this.node,"selectstart",a)};f.prototype.createList=function(){var a=this.node,b=this.list.isPartOfDiscsList?t("discNumber"):null,c=t("list"),d=t("body");i.addClass(a,"sp-list-style-"+this.list.options.style);if("no"!==this.list.options.header){var e=t("header");c.appendChild(e)}c.appendChild(d);b&&(b.innerHTML=this.list.discNumber,a.appendChild(b));a.appendChild(c);
this.nodes={wrapper:c,body:d,tableBody:c.querySelector(".sp-list-table-body"),headerWrapper:c.querySelector(".sp-list-header"),headerContent:c.querySelector(".sp-list-header-table-wrapper"),headerRow:c.querySelector(".sp-list-header-row"),colgroups:{header:c.querySelector(".sp-list-header .sp-list-colgroup"),body:c.querySelector(".sp-list-body .sp-list-colgroup")}}};f.prototype.addFields=function(){var a,b,c,d,e,j,g,f,h;a="no"!==this.list.options.header;b=this.list.model.fields;c=this.nodes.headerRow;
d=this.nodes.colgroups;e=0;for(j=b.length;e<j;e++){if(a){g=document.createElement("th");g.className="sp-list-heading "+b[e].className;g.innerHTML=b[e].title||"&nbsp;";!h&&!b[e].fixedWidth&&(h=!0);if((!b[e].fixedWidth||b[e+1]&&!b[e+1].fixedWidth)&&h&&(b[0].fixedWidth&&0<e||!b[0].fixedWidth)&&(b[j-1].fixedWidth&&e<j-2||!b[j-1].fixedWidth))f=document.createElement("div"),f.className="sp-list-heading-handle",f.colIndex=e,this.makeResizable(f),g.appendChild(f);c.appendChild(g);g=document.createElement("col");
d.header.appendChild(g)}g=document.createElement("col");d.body.appendChild(g)}};f.prototype.updateWidths=function(){this.fullWidth=this.node.offsetWidth;this.list.dispatchEvent("resize");this.list.parentList&&this.list.parentList.dispatchEvent("resize");var a=this.list.options;"dynamic"===a.height&&("fixed"===a.header&&this.nodes.headerWrapper.fixed)&&(this.nodes.headerWrapper.style.width=this.fullWidth+"px");"fixed"===a.height&&"fixed"===a.header&&(this.nodes.headerContent.style.width=(this.nodes.tableBody.offsetWidth||
this.nodes.body.offsetWidth)+"px");var b,c,d,e,j,g;b="no"!==this.list.options.header;c="toplist"===this.list.layout;a=this.list.model.fields;d=this.nodes.colgroups;e=d.header&&d.header.children;j=d.body.children;d=c?this.nodes.tableBody.querySelectorAll(".sp-list-item"):void 0;if(c){var f=0;c=0;for(g=d.length;c<g;c++){b=d[c].children;e=f=0;for(j=b.length;e<j;e++)if(a[e].fixedWidth)f+=a[e].fixedWidth;else if("track"===a[e].id){var h=parseInt(i.getStyle(b[e],"padding-right"),10);b[e].style.paddingLeft=
f+h+"px"}else b[e].style.width=100*a[e].width+"%"}}else{c=0;for(g=a.length;c<g;c++)d=a[c].fixedWidth?a[c].width+"px":100*a[c].width+"%",j[c].style.width=d,b&&(e[c].style.width=d)}};f.prototype.checkResizeEdge=function(){var a=this.node.getBoundingClientRect().height,b=this.nodes.tableBody.getBoundingClientRect().height,c=this.list.model.isFetchingMore,b=a===this.visibleHeight?b:b-2*this.visibleHeight;this.updateVisibleHeight();!c&&a>b&&this.list.model.moreWithLimit(1E3)};f.prototype.getNumItemsPerBucket=
function(){var a=this.list.options.numItems,b=this.list.options.fetch;if(0<a||"greedy"!==b){this.updateVisibleHeight();var c=document.createElement("tr");c.className="sp-list-item";c.innerHTML='<td class="sp-list-cell"></td>';this.nodes.tableBody.appendChild(c);this.itemHeight=c.offsetHeight;this.nodes.tableBody.removeChild(c)}0<a?this.list.model.numItemsPerBucket=a:"greedy"===b?this.list.model.numItemsPerBucket=50:(a=Math.floor(this.visibleHeight/this.itemHeight),this.list.model.numItemsPerBucket=
50<a?50:a)};f.prototype.updateVisibleHeight=function(){var a=this.list.options.scrollElement||("fixed"===this.list.options.height?this.node.parentNode:void 0);this.visibleHeight=a?a.offsetHeight:window.innerHeight};f.prototype.removeItems=function(a,b){for(var c=this.rows,d=this.shownIndices,e=this.rows[0].parentNode,j=a;j<b;j++)e.removeChild(c[j]);c.splice(a,b-a);var c=d.slice(0,a),d=this.shownIndices.slice(b,d.length),g=b-a,d=d.map(function(a){return a-g});this.shownIndices=c.concat(d)};f.prototype.createItems=
function(a,b){if(!this.list.destroyed){for(var c=this.list.model.items,d=document.createDocumentFragment(),e,j=a;j<b;j++)e=this.getItem(c[j],j),d.appendChild(e);e=(c=this.nodes.tableBody.children[a-1])&&c.nextSibling;j=this.nodes.tableBody.children[a];e=!e?j:e;(c||j)&&e?this.nodes.tableBody.insertBefore(d,e):this.nodes.tableBody.appendChild(d);this.list.model.isFetchingMore=!1}};f.prototype.getItem=function(a,b){if(!this.list.destroyed){var c=this,d=document.createElement("tr");v.drag.hasDragSupport&&
d.setAttribute("draggable","true");d.className="sp-list-item";d.setAttribute("data-uri",a.uri);this.rows[b]?this.rows.splice(b,0,d):this.rows[b]=d;this.list.model.loadItem(b,function(a,j){if(!c.list.destroyed){c.numLoadedItems++;var g=c.list.model,f=g.items,h=f[b],m=g.itemData[b],l=c.list,w=l.options,n=g.snapshots[m.snapshotIndex];n.numItemsLoaded++;a.error?(m.hidden=!0,i.addClass(d,"sp-list-item-hidden"),c.numLoadedItems===g.totalLength&&!c.hasFoundPlayableTrack&&l.dispatchEvent({type:"visually-empty"}),
l.dispatchEvent({type:"item-load-fail",index:b,item:h,row:d}),l.parentList&&l.parentList.dispatchEvent({type:"item-load-fail",index:b,item:h,row:d}),n.numItemsLoaded===n.numItems&&(l.dispatchEvent({type:"snapshot-load",index:m.snapshotIndex,items:f.slice(n.start,n.end)}),l.parentList&&l.parentList.dispatchEvent({type:"snapshot-load",index:m.snapshotIndex,items:f.slice(n.start,n.end)}))):(a.imageOptions=l.options.imageOptions,l.isTrackList&&"hidden"===w.unplayable&&(a.track.playable&&(c.hasFoundPlayableTrack=
!0),c.numLoadedItems===g.totalLength&&!c.hasFoundPlayableTrack&&l.dispatchEvent({type:"visually-empty"})),l.isTrackList&&(c.updatePlayability(h,m,d,a.track.playable),a.track.playable||(m.playableChangeHandler=function(){c.updatePlayability(h,m,d,h.playable)},h.addEventListener("change:playable",m.playableChangeHandler),c.list.eventHandlers.push({type:"change:playable",handler:m.playableChangeHandler,obj:h,dom:!1}))),c.createRowFromData(a,d),j&&c.updateWidths(),m.loaded=!0,l.dispatchEvent({type:"item-load",
index:b,item:h,row:d}),l.parentList&&l.parentList.dispatchEvent({type:"item-load",index:b,item:h,row:d}),n.numItemsLoaded===n.numItems&&(l.dispatchEvent({type:"snapshot-load",index:m.snapshotIndex,items:f.slice(n.start,n.end)}),l.parentList&&l.parentList.dispatchEvent({type:"snapshot-load",index:m.snapshotIndex,items:f.slice(n.start,n.end)})),"fixed"===w.height&&"fixed"===w.header&&(c.nodes.headerContent.style.width=(c.nodes.tableBody.offsetWidth||c.nodes.body.offsetWidth)+"px"))}});return d}};f.prototype.updatePlayability=
function(a,b,c,d){this.list.isTrackList&&!d?(i.addClass(c,"sp-list-item-unplayable"),"hidden"===this.list.options.unplayable&&(i.addClass(c,"sp-list-item-hidden"),b.hidden=!0)):(i.removeClass(c,"sp-list-item-unplayable"),i.removeClass(c,"sp-list-item-hidden"),b.hidden=!1)};f.prototype.createRowFromData=function(a,b){var c,d,e,j,g,f,h,m,l,w;c="toplist"===this.list.layout;d=document.createDocumentFragment();e=this.list.model.fields;j=this.list.options.fields;var n=this.list.isTrackList,p=this.list.isAlbumItem;
g=this.list.albumArtists;var r=0;f=[];var q,k,u,s,t;if(a.artists){k=0;for(t=a.artists.length;k<t;k++)f.push(a.artists[k].uri)}f=f.join(" ");k=f!==g;t=a.track.explicit;g=0;for(f=e.length;g<f;g++){m=void 0;q="trackartist"===j[g];s="track"===j[g];if(n&&!c&&p&&q)if(k)h&&i.hasClass(h,"sp-list-cell-track")&&(u=h.querySelector(".sp-list-contextbutton"))&&h.removeChild(u);else if(h&&void 0===h.fixedWidth){h.style.width=100*e[g-1].width+100*e[g].width+"%";h.setAttribute("colspan","2");continue}else m="";h=
document.createElement("td");h.className="sp-list-cell "+(e[g].className||"");q&&(h.className+=" sp-list-cell-trackartist");m=void 0===m?e[g].get(a):m;if(q&&k&&u)if(h.appendChild(u),u=null,"string"===typeof m)m='<span class="sp-list-cell-artist-names">'+m+"</span>";else{var v=document.createElement("span");span.className="sp-list-cell-artist-names";v.appendChild(m);m=v}"string"===typeof m?h.innerHTML+=m:h.appendChild(m);if(t&&(s&&c||s&&!k||q&&k))m=document.createElement("span"),m.className="sp-icon-explicit",
(u=h.querySelector(".sp-list-contextbutton"))?u.parentNode.insertBefore(m,u.nextSibling):h.insertBefore(m,h.firstChild);if(e[g].fixedWidth)h.fixedWidth=e[g].fixedWidth,r+=e[g].fixedWidth;else if(!c||c&&!~"track album".indexOf(e[g].id))h.style.width=100*e[g].width+"%";d.appendChild(h);"track"===e[g].id&&(l=h);"album"===e[g].id&&(w=h)}b.appendChild(d);if(-1<this.list.options.fields.indexOf("ordinal")&&(d="hidden"===this.list.options.unplayable,e=a.track.playable,!this.list.model.itemData[a.index].hidden&&
(!d||e)))e=this.shownIndices.indexOf(a.index),-1<e?(d=this.shownIndices.slice(0,e),e=this.shownIndices.slice(e,this.shownIndices.length),e=e.map(function(a){return a+1}),this.shownIndices=d.concat([a.index]).concat(e)):(this.shownIndices.push(a.index),this.shownIndices.sort(function(a,b){return a-b})),this.updateOrdinalsFrom(a.index);c&&(l||w)&&this.setToplistCellOffset(l,w,b,r)};f.prototype.setToplistCellOffset=function(a,b,c,d){var e=i.getStyle(a||b,"padding-right");if(""===e){var j=this,g=a||b;
g.numOffsetTries=(g.numOffsetTries||0)+1;if(10<=g.numOffsetTries)delete g.numOffsetTries;else{setTimeout(function(){j.setToplistCellOffset(a,b,c,d)},50);return}}e=parseInt(e||0,10);d+=e;a&&b?(e=document.createElement("div"),e.className="sp-list-cell sp-list-cell-trackalbum-wrapper",c.replaceChild(e,b),c.removeChild(a),e.appendChild(a),e.appendChild(b),e.style.paddingLeft=d+"px"):a?a.style.paddingLeft=d+"px":b&&(b.style.paddingLeft=d+"px")};f.prototype.makeResizable=function(a){var b=this,c=function(c){b.handleDragStart(a,
c)},d=function(c){b.handleDragMove(a,c)},e=function(c){b.handleDragEnd(a,c)};this.list.eventHandlers.push({type:"mousedown",handler:c,obj:a,dom:!0});this.list.eventHandlers.push({type:"mousemove",handler:d,obj:document,dom:!0});this.list.eventHandlers.push({type:"mouseup",handler:e,obj:document,dom:!0});k.addEventListener(a,"mousedown",c);k.addEventListener(document,"mousemove",d,!0);k.addEventListener(document,"mouseup",e,!0)};f.prototype.handleDragStart=function(a,b){for(var c=this.list.model.fields,
d=a.colIndex;c[d]&&c[d].fixedWidth;)d--;for(var e=a.colIndex+1;c[e]&&c[e].fixedWidth;)e++;c[d]&&c[e]&&(this.currentHandle=a,a.isDragging=!0,a.startPos=b.pageX||b.clientX,a.leftIndex=d,a.rightIndex=e,a.startLeftWidth=c[d].dynamicWidth,a.startRightWidth=c[e].dynamicWidth)};f.prototype.handleDragMove=function(a,b){if(a.isDragging&&a===this.currentHandle){var c=(b.pageX||b.clientX)-a.startPos,d=this.list.model.fields,e=a.startLeftWidth*d.totalDynamicWidth+c,c=a.startRightWidth*d.totalDynamicWidth-c;50<
e&&50<c&&(d[a.leftIndex].dynamicWidth=e/d.totalDynamicWidth,d[a.rightIndex].dynamicWidth=c/d.totalDynamicWidth,this.updateWidths())}};f.prototype.handleDragEnd=function(a){if(a===this.currentHandle){a.isDragging=!1;this.currentHandle=null;var b=this.list.model.fields,a={type:"column-resize",left:{index:a.leftIndex,startWidth:a.startLeftWidth,endWidth:b[a.leftIndex].dynamicWidth},right:{index:a.rightIndex,startWidth:a.startRightWidth,endWidth:b[a.rightIndex].dynamicWidth}};this.list.dispatchEvent(a);
this.list.parentList&&this.list.parentList.dispatchEvent(a)}};f.prototype.onScroll=function(){var a=this.list.options,b=this.nodes.headerWrapper,c=this.scrollElement,d=this.list.model,e=this.node.getBoundingClientRect();if("fixed"===a.header&&"dynamic"===a.height){var a=b.offsetHeight,j=b.getBoundingClientRect().top,g=0;c!==window&&(g=parseFloat(i.getStyle(c,"border-top-width"),10),g=isNaN(g)?0:g,g=c.getBoundingClientRect().top+g);if(!b.fixed&&j<=g&&e.bottom>g+a)i.addClass(b,"sp-list-header-fixed"),
i.addClass(this.node,"sp-list-wrapper-header-fixed"),b.style.width=(this.nodes.tableBody.offsetWidth||this.nodes.body.offsetWidth)+"px",b.style.top=g+"px",b.fixed=!0;else if(b.fixed&&(j>g||e.top>g||e.bottom<g+a))i.removeClass(b,"sp-list-header-fixed"),i.removeClass(this.node,"sp-list-wrapper-header-fixed"),b.style.width="100%",b.style.top="auto",b.fixed=!1}!this.list.options.numItems&&("scroll"===this.list.options.fetch&&!this.list.model.noMoreData)&&(b=this.nodes.tableBody.getBoundingClientRect(),
e=c.pageYOffset||(c===window?document.documentElement.scrollTop:c.scrollTop),c=c===(this.list.options.scrollElement||window)?e+b.top:0,!d.isFetchingMore&&e>c+b.height-2*this.visibleHeight&&d.moreWithLimit(1E3))};f.prototype.selectItem=function(a){var b=this.list.model.getListChain();if(1<b.length)for(var c=0,d=b.length;c<d;c++)b[c].view.dontBlur=!0;b=this.rows[a];i.addClass(b,"sp-list-item-selected");this.list.dispatchEvent({type:"item-select",index:a,item:this.list.model.items[a],row:b});this.list.parentList&&
this.list.parentList.dispatchEvent({type:"item-select",index:a,item:this.list.model.items[a],row:b})};f.prototype.deselectItem=function(a){var b=this.rows[a];i.removeClass(b,"sp-list-item-selected");this.list.dispatchEvent({type:"item-deselect",index:a,item:this.list.model.items[a],row:b});this.list.parentList&&this.list.parentList.dispatchEvent({type:"item-deselect",index:a,item:this.list.model.items[a],row:b})};f.prototype.deselect=function(){for(var a=this.selection.getSelectionForList(this.list.listIndex),
b=0,c=a.length;b<c;b++)this.deselectItem(a[b])};f.prototype.makeFocusable=function(){this.dontBlur=!1;var a=this,b=this.node,c=void 0!==window.onfocusin,d=c?"focusin":"focus",c=c?"focusout":"blur";b.tabIndex=0;var e=function(){i.addClass(this,"sp-list-wrapper-focus")};this.list.eventHandlers.push({type:d,handler:e,obj:b,dom:!0});k.addEventListener(b,d,e,!1);d=function(){a.dontBlur||i.removeClass(this,"sp-list-wrapper-focus")};this.list.eventHandlers.push({type:c,handler:d,obj:b,dom:!0});k.addEventListener(b,
c,d,!1);"no"!==this.list.options.header&&(d=function(){a.dontBlurHeader=!0},this.list.eventHandlers.push({type:"mousedown",handler:d,obj:this.nodes.headerWrapper,dom:!0}),k.addEventListener(this.nodes.headerWrapper,"mousedown",d,!1),d=function(){a.dontBlurHeader&&b.focus();a.dontBlurHeader=!1},this.list.eventHandlers.push({type:"mouseup",handler:d,obj:document,dom:!0}),k.addEventListener(document,"mouseup",d,!1))};f.prototype.isElementInAnyListView=function(a){for(;a!==document&&!i.hasClass(a,"sp-list");)a=
a.parentNode;return a!==document?!0:!1};f.prototype.isElementInAnyConnectedListView=function(a){for(;a!==document&&!i.hasClass(a,"sp-list");)a=a.parentNode;for(var b=this.list.model.getListChain(),c=0,d=b.length;c<d;c++)b[c]=b[c].node;return a!==document?!!~b.indexOf(a):!1};f.prototype.getListNodeFromElement=function(a){for(var b=document.body;a!==b&&(!i.hasClass(a,"sp-list")||a.getAttribute("data-is-disc"));)a=a.parentNode;return a===b?null:a};f.prototype.fixConnectedListsFocus=function(){var a=
this,b=!1,c=this.list,d=this.list.model;f.listViewConnectedContainerArray||(f.listViewConnectedContainerArray=[]);this.list.parentList&&(b=!0,c=this.list.parentList,d=c.lists[0].model);var e=c._connectedListsIndex;if(void 0===e)for(var j=d.getListChain(),d=0,g=j.length;d<g;d++)if(void 0!==j[d]._connectedListsIndex){e=j[d]._connectedListsIndex;break}j=!1;if(b)for(var x=f.listViewConnectedContainerArray,h,d=0,g=x.length;d<g;d++){h=x[d];for(var m=0,l=h.length;m<l;m++)h[m]===c&&(j=!0)}if(void 0===e&&
!j)e=f.listViewConnectedContainerArray.push([c])-1,c._connectedListsIndex=e,c.node.setAttribute("data-connected-lists-index",e),f.listViewDocMouseDownHandler||(f.listViewDocMouseDownHandler=function(b){for(var c=[],d=[],e=[],c=f.listViewConnectedContainerArray,g=0,j=c.length;g<j;g++)e=e.concat(c[g]);if(a.isElementInAnyListView(b.target)){g=a.getListNodeFromElement(b.target).getAttribute("data-connected-lists-index");c=f.listViewConnectedContainerArray[g];g=0;for(j=c.length;g<j;g++)for(var b=c[g],
b=b.isDiscsList?b.lists:[b],h=0,m=b.length;h<m;h++)i.addClass(b[h].view.node,"sp-list-wrapper-focus");g=0;for(j=e.length;g<j;g++)-1===c.indexOf(e[g])&&d.push(e[g])}else d=e;g=0;for(j=d.length;g<j;g++){b=d[g];b=b.isDiscsList?b.lists:[b];h=0;for(m=b.length;h<m;h++)b[h].view.dontBlur=!1,i.removeClass(b[h].view.node,"sp-list-wrapper-focus")}},k.addEventListener(document,"mousedown",f.listViewDocMouseDownHandler));else if(!b||!j)f.listViewConnectedContainerArray[e].push(c),c._connectedListsIndex=e,c.node.setAttribute("data-connected-lists-index",
e)};f.prototype.addDragListener=function(){var a=this;if(!this.selection.isDndAdded){this.selection.isDndAdded=!0;var b,c=function(c){return!(c instanceof HTMLAnchorElement)&&a.isElementInAnyConnectedListView(c)?(b=a.selection.getSelectionData(),0<b.uris.length):!1},d=function(){var c=b.urls.join("\n"),d=b.urls.map(function(c,d){var e=b.items[d];if(e instanceof s.Track)var g=a.getArtistsAsString(e.artists),e=e.name+" by "+g;else e=c;return'<a href="'+c+'">'+e+"</a>"}).join("<br>\n");return{"text/plain":c,
"text/html":d}},e=function(){var c=b.uris.length,d=a.list.isTrackList;return 1===c&&d?(c=b.items[0],d=a.getArtistsAsString(c.artists),c.name+" by "+d):c+" "+(d?"tracks":"items")};v.drag.addHandler(c,d,e);this.dndTestFunc=c;this.dndGetDataFunc=d;this.dndGetTextFunc=e}};f.prototype.removeDndHandlers=function(){this.dndTestFunc&&(this.dndGetDataFunc&&this.dndGetTextFunc)&&v.drag.removeHandler(this.dndTestFunc,this.dndGetDataFunc,this.dndGetTextFunc)};f.prototype.getArtistsAsString=function(a){for(var b=
"",c=0,d=a.length;c<d;c++)b+=a[c].name+(c<d-1?", ":"");return b};f.prototype.makeSelectable=function(){var a=this;"desktop"===this.list.model.userDevice&&(this.nodes.tableBody.oncontextmenu=function(b){if("a"===b.target.tagName.toLowerCase()){var d=b.target.getAttribute("data-uri");if(d){var e=s.fromURI(d);if(e)return d=b.pageX-window.pageXOffset,b=b.pageY-window.pageYOffset,s.client.showContextUI(e,{x:d,y:b}),!1}}else if(e=a.selection.getSelectionData(),0<e.items.length){var j=e.fromSameList?a.list.item:
void 0,d=b.pageX-window.pageXOffset,b=b.pageY-window.pageYOffset;s.client.showContextUI(e.items,{x:d,y:b},j);return!1}});var b=function(b){a.listMouseDown(b,this)};this.list.eventHandlers.push({type:"mousedown",handler:b,obj:this.nodes.tableBody,dom:!0});k.addEventListener(this.nodes.tableBody,"mousedown",b);b=function(b){a.listKeyDown(b,this)};this.list.eventHandlers.push({type:"keydown",handler:b,obj:this.node,dom:!0});k.addEventListener(this.node,"keydown",b,!0);this.list.isTrackList&&(b=function(b){a.listDblClick(b,
this)},this.list.eventHandlers.push({type:"dblclick",handler:b,obj:this.nodes.tableBody,dom:!0}),k.addEventListener(this.nodes.tableBody,"dblclick",b));b=function(b){a.listClick(b,this)};this.list.eventHandlers.push({type:"click",handler:b,obj:this.nodes.tableBody,dom:!0});k.addEventListener(this.nodes.tableBody,"click",b)};f.prototype.fixWidgetButtonVisibility=function(){f.listViewDocMouseMoveHandler?f.listViewContainerArray&&f.listViewContainerArray.push(this.list):(f.listViewContainerArray=[this.list],
f.listViewDocMouseMoveHandler=function(){var a=f.listViewContainerArray;if(a)for(var b=0,c=a.length;b<c;b++){var d=a[b];d.destroyed?(a.splice(b,1),b--,c--):d.view.popupShown&&d.view.hideWidgetButtons()}},k.addEventListener(document,"mousemove",f.listViewDocMouseMoveHandler))};f.prototype.hideWidgetButtons=function(){for(var a=k.queryClasses("sp-list-contextbutton-popup",this.nodes.listBody),b=0;b<a.length;b++)i.removeClass(a[b],"sp-list-contextbutton-popup");this.popupShown=!1};f.prototype.listMouseDown=
function(a){if(!i.hasClass(a.target,"sp-icon-star")&&!i.hasClass(a.target,"sp-icon-star-hitarea")&&!i.hasClass(a.target,"sp-list-sharebutton")&&!i.hasClass(a.target,"sp-list-share-hitarea")&&"a"!==a.target.tagName.toLowerCase())if(~this.list.options.fields.indexOf("track")&&"web"===this.list.model.userDevice&&i.hasClass(a.target,"sp-list-contextbutton")){var b=a.target.parentNode.parentNode.getAttribute("data-uri"),c=this.list.item.uri;i.addClass(a.target,"sp-list-contextbutton-popup");this.popupShown=
!0;z.show("context-actions",[b],a.target,c)}else(b=this.getListRowNode(a.target))&&this.handleMouseSelection(b,a)};f.prototype.handleMouseSelection=function(a,b,c){var d=a.parentNode.children,d=Array.prototype.slice.call(d,0,d.length),a=d.indexOf(a);if(!c||!this.changedSelectionOnMouseDown)if(this.changedSelectionOnMouseDown=!1,~a){var d={"0":1,2:2,1:3,"default":0},d=d[b.button]||d["default"],e=1===d,j=2===d,d=this.list.listIndex,g=this.selection,f=b.shiftKey||b.metaKey||b.ctrlKey,b=!b.shiftKey,h=
g.isSelected(a,d);if(f&&b&&h&&e)c=g.focus.item,b=g.focus.list,e=g.origin,j=c>e.item,e=a+((b===e.list?!j:!(b>e.list))?-1:1),e=-1<g.indices[d].indexOf(e)?e:!1,this.changedSelectionOnMouseDown=!0,g.remove(a,d),!1!==e&&g.setOrigin(e,d),g.setFocus(c,b);else if(b){if((!j||!h)&&(!e||!h||c))f||g.clear(),g.add(a,d),g.setOrigin(a,d),this.changedSelectionOnMouseDown=!0}else g.isInCurrentGroup(a,d)?g.removeTo(a+(g.isDirectionDown?1:-1),d):g.addTo(a,d),this.changedSelectionOnMouseDown=!0}};f.prototype.listKeyDown=
function(a){var b=38===a.keyCode,c=40===a.keyCode;13===a.keyCode&&(this.selection.hasSelection(this.list.listIndex)&&this.list.isTrackList)&&(a.preventDefault(),a.stopPropagation(),this.list.playTrack(this.selection.getIndex(0,this.list.listIndex),this.list.discNumber-1));(b||c)&&(!a.metaKey&&!a.ctrlKey)&&this.moveSelection(c,a)};f.prototype.listDblClick=function(a){!i.hasClass(a.target,"sp-icon-star")&&!i.hasClass(a.target,"sp-icon-star-hitarea")&&(a=a.target.tagName.toLowerCase(),"a"!==a&&"button"!==
a&&this.list.playTrack(this.selection.getIndex(0,this.list.listIndex),this.list.discNumber-1))};f.prototype.listClick=function(a){var b=a.target,c=b.getAttribute("data-uri"),d=!!c&&0===c.indexOf("spotify:"),e=b.getAttribute("data-button"),e=!!e&&"share"===e,j=i.hasClass(a.target,"sp-icon-star")||i.hasClass(a.target,"sp-icon-star-hitarea");if(d)a.preventDefault(),a.stopPropagation(),this.list.dispatchEvent({type:"list-click",uri:c}),this.list.parentList&&this.list.parentList.dispatchEvent({type:"list-click",
uri:c}),s.application.openURI(c);else if(e)this.openShareUI(b);else if(j){if(b=this.getListRowNode(a.target)){var g=b.querySelector(".sp-icon-star"),f=!!b.querySelector(".sp-icon-starred"),c=b.getAttribute("data-uri"),h=s.Track.fromURI(c);i[f?"removeClass":"addClass"](g,"sp-icon-starred");h.load("starred").done(function(){h.starred===f&&h[h.starred?"unstar":"star"]().fail(function(){i[f?"addClass":"removeClass"](g,"sp-icon-starred")})})}}else(b=this.getListRowNode(a.target))&&this.handleMouseSelection(b,
a,!0)};f.prototype.openShareUI=function(a){var b=this.getListRowNode(a);b&&(b=b.getAttribute("data-uri"),a=a.getBoundingClientRect(),s.client.showShareUI(b,"",{x:a.left+a.width/2,y:a.top+a.height/2}))};f.prototype.getListRowNode=function(a){for(var b=this.nodes.tableBody;a!==b&&!i.hasClass(a,"sp-list-item");)a=a.parentNode;return a===b?null:a};f.prototype.moveSelection=function(a,b){if(this.selection.focus.list===this.list.listIndex){var c=this.list.model.items,d=this.list.model.itemData,e=this.selection.focus.item,
f=e+(a?1:-1),g=c[f],i=d[f],h=!a&&0===e,m=a&&e===c.length-1,l=this.selection,k=l.isDirectionDown,n=l.isDirectionUp,p=this.list.listIndex,r=l.origin.list,q=l.origin.item;if(h||m){for(c=h?this.list.previousList:this.list.nextList;;){if(c&&c.lists){c=h?c.lists[c.lists.length-1]:c.lists[0];break}if(this.list.isPartOfDiscsList&&!c&&(c=h?this.list.parentList.previousList:this.list.parentList.nextList))continue;break}if(c){b&&b.preventDefault();h=h?c.model.items.length-1:0;d=c.listIndex;g=c.view.selection;
if(!b||!b.shiftKey||!l.multiselectEnabled)g.clear(),g.setOrigin(h,c.listIndex),q=h,r=c.listIndex,k=n=!1;k=k&&a||n&&!a||!k&&!n;!g.isSelected(h,d)&&k?(g.add(h,d),b&&b.shiftKey?(g.isDirectionDown=p>r?!0:p<r?!1:f>q?!0:!1,g.isDirectionUp=p<r?!0:p>r?!1:f<q?!0:!1):(g.isDirectionDown=!1,g.isDirectionUp=!1)):k?g.setFocus(h,d):l.remove(e,p);c.focus()}}else{for(;f<c.length-1&&-1<f&&!g||i&&!i.loaded||i&&i.hidden;)f+=a?1:-1,g=c[f],i=d[f];if(g){b&&(b.preventDefault(),b.stopPropagation());if(!b||!b.shiftKey||!l.multiselectEnabled)l.clear(),
l.setOrigin(f,p),q=f,r=p,k=n=!1;k=k&&a||n&&!a||!k&&!n;!l.isSelected(f,p)&&k?(l.add(f,p),b&&b.shiftKey?(l.isDirectionDown=p>r?!0:p<r?!1:f>q?!0:!1,l.isDirectionUp=p<r?!0:p>r?!1:f<q?!0:!1):(l.isDirectionDown=!1,l.isDirectionUp=!1)):k?l.setFocus(e+(a?1:-1),p):l.isSelected(e,p)?l.remove(e,p):l.setFocus(e+(a?1:-1),p);e=this.scrollElement;l=e===window;q=this.rows[f].getBoundingClientRect();k=(f=this.nodes.headerWrapper)&&f.getBoundingClientRect().bottom;n=l?0:this.node.getBoundingClientRect().top;p="fixed"===
this.list.options.header;r="dynamic"===this.list.options.height;h=p?k:n;c=l?window.innerHeight:e.getBoundingClientRect().bottom;if(q.top<h||q.bottom>c)k=e.pageXOffset||(e===window?document.documentElement.scrollLeft:e.scrollLeft),n=e.pageYOffset||(e===window?document.documentElement.scrollTop:e.scrollTop),q=e===window?a?q.bottom-window.innerHeight:q.top:a?q.bottom-c:q.top-h,f=!a&&p&&r&&l?f.offsetHeight:0,e.scrollTo?e.scrollTo(k,n+q-f):e.scrollTop=n+q-f}}}};f.prototype.playerChange=function(){function a(){if(!b.list.destroyed){var a=
!(!e.context||!(c.context&&e.context.uri===c.context.uri)),f=d?b.list.isDisc?b.list.discNumber===d.disc:!0:!1;if(a&&b.isPlaying&&b.list.model.contextHasUpdates&&b.list.model.items[b.playingIndex+1])b.list.model.contextHasUpdates=!1,b.list.playTrack(b.playingIndex+1,b.list.discNumber-1);else{if(!a||!d||!f)return b.setPlayingState(!1);a=b.list.isDisc?d.number-1:c.index;e.items[a]?b.setPlayingState(a,c.playing):b.setPlayingState(!1);a===e.items.length-1&&b.list.more()}}}if(!this.list.destroyed){var b=
this,c=s.player,d=c.track,e=this.list.model;this.list.isDisc&&d?d.load("disc","number").done(function(){a()}):a()}};f.prototype.setPlayingState=function(a,b){if(!1!==a&&!this.rows[a]){var c=this;setTimeout(function(){c.setPlayingState(a,b)},50)}else if(!this.playingRow||!(this.playingIndex===a&&b===this.playingRow.playing))if(this.playingRow&&(i.removeClass(this.playingRow,"sp-list-item-playing"),i.removeClass(this.playingRow,"sp-list-item-paused"),this.isPlaying=!1,this.playingIndex=this.playingRow=
null),!1!==a){var d=this.rows[a];i.addClass(d,b?"sp-list-item-playing":"sp-list-item-paused");this.playingRow=d;this.playingRow.playing=b;this.isPlaying=!0;this.playingIndex=a}};f.prototype.updateStarred=function(a,b){for(var c=this.list.model.uris,d=this.rows,e="insert"===a,f,g,k=0,h=b.length;k<h;k++)if(f=c.indexOf(b[k]),-1<f&&(f=d[f]))if(f=f.querySelector(".sp-icon-star"),g=i.hasClass(f,"sp-icon-starred"),g!==e)i[e?"addClass":"removeClass"](f,"sp-icon-starred")};f.prototype.updateOrdinalsFrom=function(a){var b=
this.list.options.fields.indexOf("ordinal");if(~b){var c=this.list,d=this.rows,e=c.model.items,f=c.model.itemData,g=c.model.fields,i="hidden"===c.options.unplayable,h=this.shownIndices.indexOf(a);-1===h&&(h=this.shownIndices.indexOf(a-1));a=h;for(h=this.shownIndices.length;a<h;a++){var k=this.shownIndices[a];if(f[k]&&!f[k].hidden||!i||e[k].playable)(k=d[k].children[b])&&g[b].update({index:a,list:c},k)}}};var B={base:'<div class="sp-list"></div>',header:'<div class="sp-list-header">\n  <div class="sp-list-header-table-wrapper">\n    <table class="sp-list-header-table">\n      <colgroup class="sp-list-colgroup"></colgroup>\n      <tbody>\n        <tr class="sp-list-header-row"></tr>\n      </tbody>\n    </table>\n  </div>\n</div>',
body:'<div class="sp-list-body">\n  <table class="sp-list-table">\n    <colgroup class="sp-list-colgroup">\n    </colgroup>\n    <tbody class="sp-list-table-body">\n    </tbody>\n  </table>\n</div>',list:'<div class="sp-list-wrapper"></div>',discNumber:'<span class="sp-list-disc-number"></span>'}});
