require(["$views/scroll-agent/scroll-agent-base#ScrollAgent","$views/utils/frame#throttle","$views/utils/range#Range"],function(g,j,i){function f(a,c){var e=this._setOptions(c||{},{batchSize:5});g.call(this,a,c);for(var d in e)this.options[d]=e[d];this.dom=[];this.spaces=[];this.data=[];this.offset=0;this.render_=j(this.render,this)}SP.inherit(f,g);f.prototype.update=function(a){if(this._fetching||!this._checkBounds(a))return this;var a=this.bounds,c=this.hotZone,e,d;(e=a.container.height<=a.view.height+
c)||(d=0>=a.container.bottom-c-a.view.bottom);(e||d)&&this._fetch(this.options.batchSize);this.render_()};g.prototype.render=function(){if(!this._destroyed){for(var a=this.bounds,c=this.hotZone,e=[],d=[],b=0;b<this.dom.length;b++){var h=this.dom[b],f=h?this.data[b]:this.spaces[b],g=f.getBoundingClientRect().top;g+f.offsetHeight<a.view.top-c||g>a.view.bottom+c?h&&d.push(b):h||e.push(b)}a=i.fromIndices(e);d=i.fromIndices(d);for(b=0;b<a.length;b++)this.show(a[b]);for(b=0;b<d.length;b++)this.hide(d[b])}};
f.prototype._createSpace=function(){return document.createElement(this.options.tagName)};g.prototype._updateSpace=function(a){this.spaces[a].style.height=this.data[a].offsetHeight+"px"};f.prototype.hide=function(a){this.log("hiding",a.start,"to",a.end);for(var c,e=document.createDocumentFragment(),d=[],b=a.start;b<a.end;b++){var h=this.data[b];d.push(h);var f=this.spaces[b]||(this.spaces[b]=this._createSpace(b));this._updateSpace(b);e.appendChild(f);c?this.container.removeChild(h):c=h;this.dom[b]=
!1}this.container.replaceChild(e,c);this.dispatchEvent({type:"hide",nodes:d});return this};f.prototype.show=function(a){this.log("showing",a.start,"to",a.end);for(var c,e=document.createDocumentFragment(),d=[],b=a.start;b<a.end;b++){var f=this.data[b];d.push(f);e.appendChild(f);f=this.spaces[b];c?this.container.removeChild(f):c=f;this.dom[b]=!0}this.container.replaceChild(e,c);this.dispatchEvent({type:"show",nodes:d});return this};f.prototype._rangeDone=function(a,c){a.length<c?this.offset+=c-a.length:
a.length>c&&(this.offset-=a.length-c);var e=document.createDocumentFragment();this.log("got",a.length,"new items");for(var d=0;d<a.length;d++){var b=a[d];e.appendChild(b);b=this.data.push(b)-1;this.dom[b]=!0}this._fetching=!1;this.container.appendChild(e);this.dispatchEvent({type:"insert",nodes:a});this.update_()};f.prototype._fetch=function(a){if(this._fetching)return this;var c=this.data.length+this.offset,e=this.length;e&&e<c+a&&(a=e-c);if(!a)return this;this._fetching=!0;this.log("fetching",a,
"new items");var d=this;this.dispatchEvent({type:"request",start:c,end:c+a,length:a,done:function(b){d._rangeDone(b,a)}});return this};exports.ScrollAgent=f});
