require(["$views/utils/range#Range","$views/scroll-agent/scroll-agent-base#ScrollAgent"],function(j,i){function f(a,d){i.call(this,a,d);this.data=[];this.empty()}SP.inherit(f,i);f.prototype.empty=function(a){var d=new j(0,this.length),e=this._createSpace(d);this.container.innerHTML="";this.container.appendChild(e);this.nodes=[];this.spaces=[d.copy()];this.ranges=[d];a&&(this.data=[]);return this};f.prototype._updateRange=function(a,d,e){a.update(d,e);a.node.style.height=a.length*this.height+"px";
return a};f.prototype._createSpace=function(a){a.type="space";var d=document.createElement(this.options.tagName);a.node=d;d.style.height=a.length*this.height+"px";return d};f.prototype._rangeFromBounds=function(){var a=this.bounds,d=this.hotZone,e=-(a.container.top-a.view.top),h=Math.floor((e-d)/this.height),a=Math.ceil((e+a.view.height+d)/this.height);return new j(h,a)};f.prototype.update=function(a){if(!this.attached)return this.show(new j(0,this.length));if(!this._checkBounds(a))return this;this.log("update\u2026");
a=this._rangeFromBounds();0>a.start&&a.update(0);a.end>this.length&&a.update(null,this.length);this.show(a);this.options.removeInvisibles&&(a=(new j(0,this.length)).subtract(a))&&a.forEach(function(a){this.hide(a)},this);return this};f.prototype._requestNodes=function(a,d){for(var e={},h=[],b=0;b<a.length;b++){var c=a.start+b,g=new j(c,c+1);g.type="node";var k=this.data[c];k?g.node=k:h.push(c);e[c]=g}var f=this,i=[],l=function(){var a=[],b;for(b in e)a.push(e[b]);i.forEach(function(a){a.split(f.nodes)});
a.sort(function(a,e){return a.start>e.start?1:-1});a=a.map(function(a){return a.start});j.fromIndices(a).forEach(function(a){for(var b=[],c=a.start;c<a.end;c++)b.push(e[c]);d.call(f,a,b)})};if(h.length){var m=j.fromIndices(h),b=0;m.forEach(function(a){this.log("requesting",a.start,a.end);this.dispatchEvent({type:"request",start:a.start,end:a.end,length:a.length,done:function(d){if(d.length>a.length)throw Error("length mismatch");for(var c=0;c<a.length;c++){var g=d[c],h=a.start+c,k=e[h];g?k.node=f.data[h]=
g:delete e[h]}d.length<a.length&&i.push(new j(a.start+d.length,a.end));++b===m.length&&l()}})},this)}else l()};f.prototype._processRange=function(a,d){for(var e=[],h=a.start,b=a.end,c=this.ranges.length;c--;){var g=this.ranges[c];if(g.end<=a.start)break;if(!(g.start>=a.end)&&(g.start<a.end||a.start<g.end))e.unshift(g),h=Math.min(h,g.start),b=Math.max(b,g.end),this.ranges.splice(c,1),this.container.removeChild(g.node),g.split(d)}c=a.insert(this.ranges,!0);return{start:h,end:b,consumed:e,index:c,previous:this.ranges[c-
1],next:this.ranges[c]}};f.prototype.hide=function(a){a.squeeze(this.spaces).forEach(function(a){a.absorb(this.spaces);this.log("hiding","from",a.start,"to",a.end);var e=this._processRange(a,this.nodes),h=e.index,b=e.previous,e=e.next,c;b&&"space"===b.type&&(c=this._updateRange(b,null,a.end));e&&"space"===e.type&&(c?(this._updateRange(b,null,e.end),this.container.removeChild(e.node),this.ranges.splice(h,1)):c=this._updateRange(e,a.start));c||(b=this._createSpace(a),this.ranges.splice(h,0,a),e?this.container.insertBefore(b,
e.node):this.container.appendChild(b))},this);return this};f.prototype.show=function(a){this.log("trying to insert",a.length,"new items from",a.start,"to",a.end);a.squeeze(this.nodes).forEach(function(a){a.absorb(this.nodes);this._requestNodes(a,function(a,d){var b=this._processRange(a,this.spaces),c=b.start,g=b.end,f=b.index,f=b.previous,b=b.next,c=a.start>c?new j(c,a.start):!1,i=a.end<g?new j(a.end,g):!1,g=document.createDocumentFragment();this.log("inserting",a.length,"new items from",a.start,
"to",a.end);c&&(f&&"space"===f.type?this._updateRange(f,null,c.end):(this._createSpace(c),c.absorb(this.spaces),d.unshift(c)));i&&(b&&"space"===b.type?this._updateRange(b,i.start):(this._createSpace(i),i.absorb(this.spaces),d.push(i)));for(f=0;f<d.length;f++)g.appendChild(d[f].node);b?(this.container.insertBefore(g,b.node),f=this.ranges.indexOf(b),[].splice.apply(this.ranges,[f,0].concat(d))):(this.container.appendChild(g),[].push.apply(this.ranges,d));this.dispatchEvent("show");this.update_()})},
this);return this};f.prototype.insert=function(a,d){this.data.length<a.start&&(this.data[a.start-1]=void 0);[].splice.apply(this.data,[a.start,0].concat(d));this.length+=a.length;this.empty();this.update_();return this};i.prototype.remove=function(a){this.data.splice(a.start,a.length);this.length-=a.length;this.empty();this.update_();return this};exports.ScrollAgent=f});
