require(["$api/models","$views/utils/css","$views/tabbar#TabBar"],function(e,h,g){function c(a){this._parseOptions(a);this._views=this.activeView=null;this.options.header&&this._createHeader();this.options.views&&this._addViews();this.options.tabs&&this._createTabBar()}SP.inherit(c,e.Observable);c.init=function(a){if(c._initialized)throw Error("UI can only be initialized once.");c._initialized=!0;return new c(a)};c.prototype.setActiveView=function(a){if(this._views&&this.activeView!==a){if(this.activeView&&
this._views[this.activeView]){var b=this.activeView;this._views[b].style.display="none";this.activeView=null}if(this._views[a])this._views[a].style.display="block",this.activeView=a;else if(a=null,!b)return;this.dispatchEvent({type:"viewchange",id:a,previousId:b})}};c.prototype._parseOptions=function(a){var b={header:!1,tabs:null,tabArgumentIndex:0,activeTab:null,views:null,container:document.body};if(a)for(var d in a)b[d]=a[d];this.options=b};c.prototype._createTabBar=function(){if(!this.options.views)throw Error("Tabs must be connected to views, but no views were defined.");
var a=this,b=this.options.tabs.map(function(a){return{id:a.viewId,name:a.name}}),d=g.withTabs(b);this.header?d.addToDom(this.header,"after"):d.addToDom(this.options.container,"prepend");d.setActiveTab(this.options.activeTab);var c=e.application;c.load("arguments","uri").done(function(){a._appArguments=c.arguments;a._appName=c.uri.replace("spotify:app:","");if(!a.options.activeTab){var f=a._getTabFromArguments()||b[0].id;a.options.activeTab=f;d.setActiveTab(f);a.setActiveView(f)}c.addEventListener("arguments",
function(b){a._onArgumentsChange(b)})});d.addEventListener("tabchange",function(b){a._onTabChange(b)});this.addEventListener("viewchange",function(a){d.activeTab!==a.id&&d.setActiveTab(a.id)});e.session.load("device");this.tabBar=d};c.prototype._addViews=function(){this._views={};for(var a=this.options.views,b=0,c=a.length;b<c;b++){if(this._views[a[b].id])throw Error("There are multiple views defined with the same ID.");this._views[a[b].id]=a[b].element;a[b].element.style.display="none"}};c.prototype._createHeader=
function(){var a=document.createElement("header");a.className="sp-header";var b=this.options.container;b.insertBefore(a,b.firstChild);this.header=a};c.prototype._onArgumentsChange=function(){this._appArguments=e.application.arguments;this._updatingArguments?this._updatingArguments=!1:(this._updatingTabBar=!0,this.tabBar.setActiveTab(this._getTabFromArguments()))};c.prototype._onTabChange=function(a){this._views&&this._views[a.id]&&SP.defer(this,function(){this.setActiveView(a.id)});this._updatingTabBar?
this._updatingTabBar=!1:"desktop"===e.session.device&&(this._updatingArguments=!0,e.application.openApp(this._appName,this._getParsedArguments(a.id)))};c.prototype._getParsedArguments=function(a){for(var b=[],c=this._appArguments,e=this.options.tabArgumentIndex,f=0,g=Math.max(c.length,e+1);f<g;f++)b.push(f===e?a:c[f]||"");return b};c.prototype._getTabFromArguments=function(){return this._appArguments[this.options.tabArgumentIndex]||this.options.activeTab};exports.UI=c});
